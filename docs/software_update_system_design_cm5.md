# 基於 Raspberry Pi CM5 的軟體更新系統設計範例 (對應 ETSI EN 303 645 5.3)

將 ETSI EN 303 645 的理論要求應用到像 Raspberry Pi Compute Module 5 (CM5) 這樣的具體硬體平台上，是確保產品合規性的關鍵步驟。

以下將基於 `### 5.3 Keep software updated (保持軟體更新)` 規範，說明如何為一款基於 Raspberry Pi CM5 的消費者物聯網產品設計一個合規、穩健且安全的更新系統。

### 核心架構

這個系統主要由三部分組成：

1.  **設備端 (Device-Side)**: 在 CM5 上運行的軟體，包括作業系統、更新客戶端和應用程式。
2.  **後端伺服器 (Backend Server)**: 儲存和分發軟體更新檔的伺服器。
3.  **開發與建構系統 (Build System)**: 用於產生完整、可驗證的系統映像檔和更新檔。

```
+---------------------------------------------------------------------------------+
|                              開發與建構系統 (Yocto/Buildroot)                   |
|                                                                                 |
|  - 產生完整的 A/B 系統映像檔 (rootfs A, rootfs B)                               |
|  - 產生包含簽章的更新檔 (.swu / .mender)                                        |
|  - 管理軟體物料清單 (SBOM)                                                      |
+---------------------------------------------------------------------------------+
       |
       | (1. 開發者上傳新的更新檔)
       v
+---------------------------------------------------------------------------------+
|                              後端更新伺服器 (Update Server)                     |
|                                                                                 |
|  - 儲存並管理不同版本的更新檔                                                   |
|  - 部署策略管理 (例如：分批推送、指定設備更新)                                  |
|  - 提供 API 供設備查詢更新                                                      |
|  - 收集設備遙測數據 (版本、更新狀態)                                            |
+---------------------------------------------------------------------------------+
       ^                                      |
       | (2. 設備定期輪詢更新)                | (3. 伺服器推送更新檔)
       |                                      v
+---------------------------------------------------------------------------------+
|                      設備端 (Raspberry Pi CM5)                                  |
+---------------------------------------------------------------------------------+
| [應用程式 & 使用者介面]                                                         |
|  - 顯示更新通知 (對應 5.3-11, 5.3-12)                                           |
|  - 提供使用者控制選項 (啟用/停用自動更新) (對應 5.3-6A, 5.3-6B)                 |
|---------------------------------------------------------------------------------|
| [更新客戶端 (RAUC / SWUpdate / Mender)]                                         |
|  - 與後端伺服器通訊                                                             |
|  - 下載更新檔                                                                   |
|  - 驗證更新檔的真實性與完整性 (數位簽章) (對應 5.3-9, 5.3-10)                   |
|  - 將更新寫入非作用中分區 (Inactive Partition)                                  |
|  - 與 Bootloader 互動，切換啟動分區                                             |
|  - 回報更新狀態 (成功/失敗)                                                     |
|---------------------------------------------------------------------------------|
| [Bootloader (e.g., U-Boot)]                                                     |
|  - 實現 A/B 啟動邏輯                                                          |
|  - 具備啟動失敗計數與自動回滾 (Rollback) 功能                                   |
|  - 實現安全啟動 (Secure Boot) (對應 5.7-1)                                      |
|---------------------------------------------------------------------------------|
| [儲存分區 (eMMC/NVMe)]                                                          |
|  - Bootloader 分區                                                              |
|  - Root Filesystem A (作用中)                                                   |
|  - Root Filesystem B (非作用中)                                                 |
|  - 使用者數據分區 (/data)                                                       |
+---------------------------------------------------------------------------------+
```

### 滿足 5.3 條款的具體實現方法

##### **條款 5.3-1 & 5.3-2: 可安全更新 & 安全的更新機制**

*   **實現方式**:
    1.  **A/B 分區**: CM5 的 eMMC 或 NVMe 儲存將被劃分為兩個完全相同的根文件系統分區（`rootfs_A` 和 `rootfs_B`）。當前運行的系統在 `rootfs_A`，更新將被寫入 `rootfs_B`。這種方式確保了即使更新過程中斷電，設備也不會變磚，因為舊的、可正常運作的系統仍然存在。
    2.  **原子性更新 (Atomic Update)**: 整個更新操作是原子性的。只有當更新檔被完整下載、驗證並寫入非作用中分區後，Bootloader 才會被告知在下次重啟時從新分區啟動。
    3.  **自動回滾**: Bootloader 會監控新系統的啟動狀態。如果新系統連續幾次啟動失敗（例如，核心崩潰或關鍵服務無法啟動），Bootloader 會自動將啟動目標切換回舊的、穩定的分區，並標記更新失敗。這極大地提高了系統的韌性。
    4.  **工具選擇**: 使用專為嵌入式 Linux 設計的更新框架，如 **RAUC**、**SWUpdate** 或 **Mender**。這些框架原生支持 A/B 更新模式，並處理了大部分複雜的底層操作。

##### **條款 5.3-7, 5.3-9, 5.3-10: 使用加密技術 & 驗證真實性與完整性**

*   **實現方式**:
    1.  **數位簽章**: 在建構系統中，使用非對稱加密（如 RSA 或 ECDSA）對生成的更新檔進行簽章。私鑰被安全地保存在離線的建構伺服器或 HSM (硬體安全模組) 中。
    2.  **公鑰內建**: 對應的公鑰被預先燒錄到設備的唯讀分區或受安全啟動保護的 Bootloader 中。
    3.  **驗證流程**: 設備上的更新客戶端在下載完更新檔後，會使用內建的公鑰來驗證其數位簽章。**只有簽章驗證通過的更新檔才會被安裝**。這可以防止攻擊者透過偽造的更新伺服器或中間人攻擊來植入惡意軟體。
    4.  **安全通訊**: 設備與後端更新伺服器之間的通訊全程使用 TLS 1.2/1.3 加密，確保更新檔在傳輸過程中的機密性和完整性。

##### **條款 5.3-3, 5.3-4A, 5.3-4B, 5.3-5, 5.3-6A/B: 使用者體驗與控制**

*   **實現方式**:
    1.  **自動化為預設**: 在設備的初始化設定流程中，應明確告知使用者有自動安全更新功能，並預設為啟用（**對應 5.3-4B**），使用者需明確同意。
    2.  **背景檢查**: 更新客戶端在背景定期（例如每天）向後端伺服器查詢是否有新更新（**對應 5.3-5**）。
    3.  **使用者控制介面**: 在設備的設定選單中，提供清晰的選項讓使用者可以：
        *   手動檢查更新。
        *   啟用或停用自動更新機制（**對應 5.3-6A**）。
        *   啟用或停用更新通知（**對應 5.3-6B**）。
    4.  **無縫更新**: 對於小型安全更新，可以設計成在背景自動下載並安裝到非作用中分區。安裝完成後，僅在下次使用者主動重啟設備時或在夜間閒置時自動重啟，以應用更新。整個過程對使用者來說幾乎是無感的（**對應 5.3-3**）。

##### **條款 5.3-11 & 5.3-12: 清晰的通知**

*   **實現方式**:
    1.  **更新通知**: 當有重要更新可用時（特別是需要使用者互動或會中斷服務的更新），設備的使用者介面應彈出清晰的通知，說明這是一個安全更新、它修復了什麼風險，以及預計的安裝時間（**對應 5.3-11**）。
    2.  **中斷警告**: 如果更新會導致設備功能（如智慧門鎖的開鎖功能）暫時中斷，通知中必須明確警告使用者「更新期間，設備將重啟且無法使用，預計耗時 2 分鐘」（**對應 5.3-12**）。

##### **條款 5.3-13 & 5.3-16: 支援期限 & 型號識別**

*   **實現方式**:
    1.  **型號識別**: 設備的型號名稱（例如 "SmartHome Hub CM5-2401"）應清晰地標示在產品外殼上，並且可以透過設備的「關於本機」或類似的軟體介面輕鬆查看。更新客戶端在上報遙測數據時也會包含此資訊（**對應 5.3-16**）。
    2.  **公開政策**: 在您的官方網站上建立一個專門的「產品支援生命週期」頁面，清楚列出每個產品型號的軟體更新支援終止日期（例如「我們將為 SmartHome Hub CM5-2401 提供安全更新至 2029 年 12 月 31 日」）。這滿足了**條款 5.3-13** 的透明度要求。

### 總結

透過在 Raspberry Pi CM5 上實施基於 **A/B 分區**的更新機制，並選用如 **RAUC** 或 **Mender** 等成熟的更新框架，您可以系統性地滿足 ETSI EN 303 645 第 5.3 節的絕大部分技術要求。這種設計不僅**安全**（透過加密驗證）、**穩健**（透過原子更新與自動回滾），也兼顧了**使用者體驗**（透過自動化和清晰的控制選項），是現代物聯網產品更新系統的最佳實踐之一。