# 5.8 Ensure that personal data is secure (確保個人資料的安全) - Raspberry Pi CM 5 系統設計範例

本文件依據 ETSI EN 303 645 標準中的「5.8 Ensure that personal data is secure (確保個人資料的安全)」規範，為基於 Raspberry Pi CM 5 的物聯網設備設計一個系統架構範例。此範例旨在說明如何在實際應用中保護個人資料的機密性、完整性，並確保使用者對資料處理的透明度。

## 1. 系統概述

本範例系統是一個智慧家庭監控設備，以 Raspberry Pi CM 5 作為核心處理單元。它包含一個攝影機模組用於影像監控，以及一個溫濕度感測器用於環境監測。設備會將收集到的資料安全地傳輸至雲端服務進行儲存、分析和使用者存取。

## 2. 硬體架構

*   **核心處理單元:** Raspberry Pi Compute Module 5 (CM 5)
    *   具備足夠的處理能力和硬體安全功能（如 TPM 或 TrustZone，若 CM 5 支援）來執行加密操作和安全啟動。
*   **感測器模組:**
    *   **攝影機模組:** 用於捕捉影像和影片串流（被視為敏感個人資料）。
    *   **溫濕度感測器:** 用於環境數據採集（被視為一般個人資料）。
*   **網路連線:** Wi-Fi 或乙太網路模組，用於與雲端服務通訊。
*   **安全儲存:** 考慮使用 CM 5 上的 eMMC 儲存或加密的 SD 卡，用於儲存設備憑證、加密金鑰和暫存的個人資料。

## 3. 資料流與安全機制

### 3.1 資料收集與本地處理

1.  **感測器數據採集:**
    *   攝影機模組捕捉影像/影片。
    *   溫濕度感測器採集環境數據。
2.  **本地處理:**
    *   CM 5 上的應用程式會對感測器數據進行初步處理，例如影像壓縮、數據格式化。
    *   **資料最小化:** 僅收集和處理實現設備功能所必需的個人資料。例如，如果僅需偵測移動，則可考慮在本地進行邊緣運算，僅傳輸事件通知而非連續影像串流。
    *   **匿名化/假名化:** 對於非敏感的溫濕度數據，如果可能且不影響功能，可考慮在本地進行匿名化或假名化處理，使其無法直接連結到特定個人。

### 3.2 資料傳輸至雲端服務 (符合 5.8-1 和 5.8-2)

所有從 Raspberry Pi CM 5 傳輸到雲端服務的個人資料，無論敏感與否，都必須透過強加密通道進行保護。

1.  **傳輸協定:** 必須使用 TLS (Transport Layer Security) 1.2 或更高版本來建立安全的通訊通道。
2.  **憑證管理:**
    *   CM 5 應預裝唯一的設備憑證，用於向雲端服務進行相互認證 (mutual authentication)。
    *   憑證應安全儲存在設備的硬體安全模組 (HSM) 或安全儲存區域中，防止未經授權的存取。
3.  **敏感個人資料的額外保護 (攝影機串流):**
    *   對於攝影機影像串流等敏感個人資料，除了 TLS 加密外，建議在應用層對數據本身進行端到端加密 (End-to-End Encryption, E2EE)。這意味著數據在 CM 5 上加密，只有授權的使用者客戶端才能解密，即使雲端服務也無法直接存取明文數據。
    *   加密演算法應採用業界最佳實踐，例如 AES-256。
    *   金鑰管理應遵循安全原則，例如使用非對稱加密來安全地交換對稱金鑰。
4.  **一般個人資料的保護 (溫濕度數據):**
    *   溫濕度數據透過 TLS 加密通道傳輸，確保機密性和完整性。

## 4. 使用者透明度與控制 (符合 5.8-3)

為了確保使用者對個人資料處理的透明度，系統必須明確告知使用者設備的外部感測能力。

1.  **設備初始化/設定介面:**
    *   在設備首次設定或透過行動應用程式設定時，應清晰地列出所有外部感測器（攝影機、麥克風、溫濕度感測器等）。
    *   應提供使用者友好的說明，解釋每個感測器收集什麼數據、數據如何使用、儲存多長時間以及誰可以存取。
    *   對於敏感感測器（如攝影機），應提供明確的啟用/停用選項，並在啟用時提供視覺指示（例如攝影機指示燈）。
2.  **隱私政策與使用條款:**
    *   製造商應提供一份易於理解的隱私政策，詳細說明所有數據處理活動，包括第三方共享（如果有的話）。
3.  **設備狀態指示:**
    *   當攝影機處於活動狀態並錄影或串流時，設備上應有清晰的物理指示（例如 LED 指示燈），讓使用者一目了然。

## 5. Python 程式碼範例 (概念性)

以下是一個概念性的 Python 程式碼範例，展示如何在 Raspberry Pi CM 5 上實現數據採集和安全傳輸的簡化邏輯。這需要 `requests` 庫和一個假設的加密庫。

```python
import requests
import json
import time
from datetime import datetime
# 假設有一個安全的加密庫，例如 cryptography
# from cryptography.fernet import Fernet # 實際應用中會更複雜，可能涉及非對稱加密和金鑰管理

# --- 配置 ---
CLOUD_API_ENDPOINT = "https://your-secure-cloud-service.com/data"
DEVICE_ID = "RPI_CM5_001"
# 假設設備有一個預先配置的 API 金鑰或憑證
# 在實際應用中，這應該從安全儲存中載入，而不是硬編碼
DEVICE_API_KEY = "YOUR_SECURE_DEVICE_API_KEY"

# 模擬感測器數據
def get_temperature_humidity():
    # 實際中會從硬體感測器讀取
    temp = 25.5
    humidity = 60.2
    return {"temperature": temp, "humidity": humidity}

def capture_camera_frame():
    # 實際中會從攝影機模組捕捉影像
    # 這裡僅為示意，返回一個模擬的二進位數據
    return b"\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x01\x00\x00\x00\x01\x08\x06\x00\x00\x00\x1f\x15\xc4\x89\x00\x00\x00\nIDATx\xda\xed\xc1\x01\x01\x00\x00\x00\xc2\xa0\xf7Om\x00\x00\x00\x00IEND\xaeB`\x82"

# 模擬加密函數 (實際應用中會更複雜)
def encrypt_data(data):
    # 這裡僅為示意，實際應使用強加密演算法和金鑰管理
    # 例如，使用 Fernet 對稱加密，但金鑰需要安全交換
    # key = Fernet.generate_key() # 實際中金鑰不會在這裡生成
    # cipher_suite = Fernet(key)
    # encrypted_data = cipher_suite.encrypt(data.encode('utf-8'))
    # return encrypted_data.decode('utf-8') # 返回 base64 編碼的密文
    return f"ENCRYPTED_{data}" # 簡化示意

def send_data_to_cloud(data_type, payload, is_sensitive=False):
    headers = {
        "Content-Type": "application/json",
        "X-Device-ID": DEVICE_ID,
        "X-API-Key": DEVICE_API_KEY # 實際中應使用更安全的認證機制，如 JWT 或簽名請求
    }

    # 對敏感數據進行應用層加密
    if is_sensitive:
        payload["encrypted_content"] = encrypt_data(json.dumps(payload["content"]))
        del payload["content"] # 移除明文內容

    try:
        response = requests.post(CLOUD_API_ENDPOINT, headers=headers, json=payload, verify=True) # verify=True 啟用 TLS 憑證驗證
        response.raise_for_status() # 如果請求失敗，拋出 HTTPError
        print(f"[{datetime.now()}] Successfully sent {data_type} data to cloud. Status: {response.status_code}")
    except requests.exceptions.RequestException as e:
        print(f"[{datetime.now()}] Failed to send {data_type} data to cloud: {e}")

# --- 主循環 ---
def main():
    print("Starting IoT device data collection and transmission...")
    while True:
        # 收集溫濕度數據
        env_data = get_temperature_humidity()
        env_payload = {
            "timestamp": datetime.now().isoformat(),
            "device_id": DEVICE_ID,
            "data_type": "environment",
            "content": env_data
        }
        send_data_to_cloud("environment", env_payload, is_sensitive=False)

        # 捕捉並傳輸攝影機數據 (敏感數據)
        camera_frame = capture_camera_frame()
        # 在實際應用中，這裡會將二進位影像數據進行 base64 編碼後再加密
        camera_payload = {
            "timestamp": datetime.now().isoformat(),
            "device_id": DEVICE_ID,
            "data_type": "camera_frame",
            "content": {"format": "PNG", "data": camera_frame.decode('latin-1')} # 簡化處理，實際應 base64 編碼
        }
        send_data_to_cloud("camera_frame", camera_payload, is_sensitive=True)

        time.sleep(10) # 每 10 秒發送一次數據

if __name__ == "__main__":
    main()
```

**程式碼說明:**

*   `CLOUD_API_ENDPOINT`: 雲端服務的 API 端點，必須使用 HTTPS。
*   `DEVICE_ID`, `DEVICE_API_KEY`: 設備識別碼和 API 金鑰，用於認證。在實際部署中，這些應從安全硬體中讀取，而非硬編碼。
*   `get_temperature_humidity()` 和 `capture_camera_frame()`: 模擬從感測器讀取數據。
*   `encrypt_data()`: 概念性的加密函數。在實際應用中，這將是一個複雜的過程，涉及金鑰管理和強加密演算法。
*   `send_data_to_cloud()`:
    *   使用 `requests.post` 發送數據。
    *   `verify=True` 確保 TLS 憑證驗證，防止中間人攻擊。
    *   對於 `is_sensitive=True` 的數據，會在傳輸前進行應用層加密（`encrypt_data` 函數）。
    *   HTTP Headers 中包含 `X-Device-ID` 和 `X-API-Key` 進行設備認證。

## 6. 部署考量

*   **安全啟動 (Secure Boot):** 確保 CM 5 僅執行經過簽名的、受信任的韌體和作業系統，防止惡意軟體篡改。
*   **最小化攻擊面:** 僅啟用必要的服務和網路埠。
*   **韌體更新:** 實施安全的韌體更新機制，確保更新的真實性和完整性。
*   **日誌記錄與監控:** 記錄所有安全相關事件，並將其安全地傳輸到雲端進行監控和異常檢測。
*   **物理安全:** 保護 CM 5 免受物理篡改，特別是對於儲存敏感金鑰的硬體。
*   **資料保留策略:** 雲端服務應有明確的資料保留策略，並在資料不再需要時安全刪除。
*   **使用者資料刪除功能:** 應提供使用者從設備和雲端服務中刪除其個人資料的簡單機制。
