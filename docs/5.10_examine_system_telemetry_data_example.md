
# 5.10 Examine system telemetry data (檢查系統遙測資料) - 範例系統

本文件依據 ETSI EN 303 645 規範中的「5.10 檢查系統遙測資料」要求，並基於先前文件假設的智慧家庭中樞（以 Raspberry Pi CM5 為硬體）與雲端服務架構，設計一個遙測資料收集與分析的範例系統。

---

## 1. 系統目標

建立一個能夠從物聯網設備（智慧家庭中樞）收集、傳輸、並分析遙測資料的系統。目標是監控設備的運行狀態、及早發現潛在的安全威脅（如異常登入、惡意連線嘗試、資源耗盡攻擊等），並為開發者提供診斷問題的依據，同時確保過程中不洩漏用戶的個人隱私資料。

## 2. 系統架構

此系統由運行在 Raspberry Pi CM5 上的「遙測代理程式」和雲端的「遙測分析平台」組成。

```mermaid
graph TD
    subgraph Raspberry Pi CM5 (智慧家庭中樞)
        A[作業系統日誌 /var/log] --> C{遙測代理程式};
        B[應用程式日誌] --> C;
        D[系統指標 (CPU, RAM, Net)] --> C;
    end

    subgraph Cloud Backend
        F[MQTT Broker];
        G[資料庫 (Time-Series DB)];
        H[分析與警報引擎];
        I[監控儀表板];
    end

    C -- 安全傳輸 (MQTT over TLS) --> F;
    F -- 寫入 --> G;
    G -- 讀取 --> H;
    H -- 觸發 --> I;
    I -- 顯示 --> J[開發/維運人員];
```

### 2.1. 設備端 (Raspberry Pi CM5)

在設備上運行的「遙測代理程式 (Telemetry Agent)」是一個背景服務，負責收集以下幾種關鍵資料：

| 資料類型 | 收集內容範例 | 目的 |
| :--- | :--- | :--- |
| **安全事件** | - 登入成功/失敗次數與來源 IP<br>- 防火牆規則阻擋記錄<br>- 軟體更新失敗記錄 | 偵測暴力破解、未經授權的存取、軟體完整性問題。 |
| **系統指標** | - CPU 使用率<br>- 記憶體使用率<br>- 網路流量（上傳/下載）<br>- 磁碟空間 | 監控設備健康狀況，偵測資源耗盡攻擊 (DoS) 或異常的資源使用。 |
| **應用程式事件** | - 應用程式啟動/關閉<br>- 嚴重錯誤 (Fatal Error) 或崩潰記錄<br>- API 呼叫頻率與延遲 | 診斷應用程式問題，發現潛在的濫用行為。 |
| **連線狀態** | - 與雲端服務的連線/斷線事件<br>- 對外連線的目標與埠號 | 監控網路穩定性，偵測異常的對外連線（如連到惡意 C&C 伺服器）。 |

**資料處理與傳輸：**

1.  **資料匿名化**：在傳輸前，代理程式會移除或遮蔽所有可能包含個人身份資訊 (PII) 的資料，例如使用者帳號、IP 位址（可轉換為地理位置或 ISP，而非原始 IP）、或日誌中的敏感字串。
2.  **資料最小化**：僅收集與安全和系統穩定性直接相關的必要資料。
3.  **批次與壓縮**：為了節省頻寬和電力，資料會先在本地批次處理，然後壓縮後再傳輸。
4.  **安全傳輸**：使用 **MQTT over TLS 1.3** 將加密後的資料傳輸到雲端，確保傳輸過程的機密性與完整性。

### 2.2. 雲端 (遙測分析平台)

1.  **MQTT Broker**：作為資料入口，接收來自所有設備的加密遙測資料。
2.  **資料庫**：建議使用時間序列資料庫 (Time-Series Database)，如 InfluxDB 或 Prometheus，專為儲存和查詢帶有時間戳的指標資料而優化。
3.  **分析與警報引擎**：
    *   **規則基礎的警報**：設定靜態閾值，例如「CPU 使用率連續 5 分鐘超過 95%」或「1 分鐘內登入失敗超過 10 次」。
    *   **異常偵測**：利用機器學習模型分析歷史資料，建立正常行為的基線 (Baseline)，並在偵測到偏離基線的行為時發出警報。例如，一個從未對外連線的設備突然開始對某個陌生 IP 傳送大量資料。
4.  **監控儀表板**：提供視覺化介面（如 Grafana），讓維運人員可以查看即時的系統狀態、查詢歷史資料，並管理警報規則。

## 3. Python 程式碼範例

這個範例展示了如何在 Raspberry Pi 上使用 `psutil` 函式庫收集系統指標，並透過 `paho-mqtt` 將其發佈到 MQTT Broker。

**安裝函式庫:**
```bash
pip install psutil paho-mqtt
```

**遙測代理程式 (簡化版 `telemetry_agent.py`):**
```python
import time
import json
import psutil
import paho.mqtt.client as mqtt

# --- 組態設定 ---
MQTT_BROKER_HOST = "your-cloud-mqtt-broker.com"
MQTT_BROKER_PORT = 8883  # TLS Port
MQTT_TOPIC = "telemetry/device-001"
DEVICE_ID = "device-001"

# --- MQTT 連線設定 ---
client = mqtt.Client(client_id=DEVICE_ID)

# 設定 TLS/SSL
# 需要將 broker 的 CA 憑證、客戶端憑證和私鑰的路徑填入
# client.tls_set(ca_certs="ca.crt",
#                certfile="client.crt",
#                keyfile="client.key")

client.connect(MQTT_BROKER_HOST, MQTT_BROKER_PORT, 60)

def get_system_telemetry():
    """
    收集系統指標，並確保不包含敏感資訊。
    """
    cpu_usage = psutil.cpu_percent(interval=1)
    memory_info = psutil.virtual_memory()
    net_io = psutil.net_io_counters()

    telemetry_data = {
        "timestamp": time.time(),
        "device_id": DEVICE_ID,
        "metrics": {
            "cpu_usage_percent": cpu_usage,
            "memory_usage_percent": memory_info.percent,
            "bytes_sent": net_io.bytes_sent,
            "bytes_recv": net_io.bytes_recv,
        }
    }
    return telemetry_data

def get_security_events():
    """
    模擬收集安全事件。
    在真實世界中，這會解析如 /var/log/auth.log 或 ufw.log 的檔案。
    這裡僅為示意。
    """
    # 範例：解析 auth.log 來計算失敗的登入
    # 注意：真實實作需要處理日誌輪替和權限問題
    # 且應匿名化 IP 位址
    failed_logins = 0
    # with open('/var/log/auth.log', 'r') as f:
    #     for line in f:
    #         if 'Failed password' in line:
    #             failed_logins += 1
    
    # 為了範例簡單，這裡使用一個假資料
    if psutil.cpu_percent(interval=1) > 50: # 模擬高負載時有安全事件
        return {
            "timestamp": time.time(),
            "device_id": DEVICE_ID,
            "event": {
                "type": "FailedLoginAttempt",
                "count": 5,
                "source_geo": "TW" # IP 已被匿名化為地理位置
            }
        }
    return None


def main():
    client.loop_start()
    while True:
        try:
            # 收集並傳送系統指標
            system_data = get_system_telemetry()
            payload = json.dumps(system_data)
            client.publish(MQTT_TOPIC + "/metrics", payload)
            print(f"Published metrics: {payload}")

            # 收集並傳送安全事件
            security_event = get_security_events()
            if security_event:
                payload = json.dumps(security_event)
                client.publish(MQTT_TOPIC + "/events", payload)
                print(f"Published event: {payload}")

            time.sleep(30)  # 每 30 秒傳送一次

        except KeyboardInterrupt:
            print("Stopping agent...")
            break
        except Exception as e:
            print(f"An error occurred: {e}")
            time.sleep(60) # 發生錯誤時等待較長時間

    client.loop_stop()
    client.disconnect()

if __name__ == "__main__":
    main()

```

## 4. 合規性說明

| ETSI EN 303 645 條款 | 實作方式 |
| :--- | :--- |
| **5.10-1 軟體應能記錄遙測資料** | 透過 `psutil` 和日誌解析，遙測代理程式可記錄安全、系統和應用程式事件。 |
| **5.10-2 遙測資料應包括安全事件** | 代理程式設計用於收集登入失敗、防火牆活動等安全相關日誌。 |
| **5.10-3 遙測資料的存取應受限制和保護** | 1. 傳輸過程使用 TLS 1.3 加密。<br>2. 雲端平台的存取需要經過身份驗證與授權。 |
| **5.10-4 設備應預設啟用遙測資料記錄** | 遙測代理程式應設計為系統服務，在設備啟動時自動運行。 |

此範例系統不僅滿足了規範要求，也為產品的長期維運和安全性提供了堅實的基礎。
