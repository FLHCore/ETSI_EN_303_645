# 5.6 Minimize exposed attack surfaces (最小化暴露的攻擊表面) 範例

本文件旨在提供一個智慧家庭 IoT 中樞主機（Hub）與雲端服務（Cloud Service）之間如何實現最小化暴露攻擊表面的 Python 程式碼範例。

## 情境

一個智慧家庭中樞主機（Hub）負責收集來自家庭內部各種感測器（例如：溫度、濕度感測器）的資料，然後將這些資料安全地傳送到雲端服務進行儲存和分析。

## 攻擊表面最小化策略

為了最小化攻擊表面，我們將遵循以下原則：

1.  **關閉未使用的網路連接埠**：Hub 和雲端服務都只開放必要的通訊埠。
2.  **禁用未使用的服務**：程式碼中不包含非核心功能的服務，例如遠端偵錯介面或 Shell。
3.  **限制外部存取**：雲端服務只接受來自特定來源（Hub）的請求。
4.  **最小化 API 端點**：雲端服務只提供一個用於接收資料的 API 端點，其他所有路徑均被阻擋。
5.  **輸入驗證**：對所有傳入的資料進行嚴格的格式和內容驗證。

---

## 程式碼範例

### 1. 智慧家庭中樞主機 (hub.py)

這個 Hub 程式碼模擬了一個在本地網路上運行的服務。它只在本地網路上監聽一個特定埠，從而避免將其直接暴露在公共網際網路上。

```python
# hub.py
import socket
import json
import time
import requests

# --- 設定 ---
# 監聽本地網路中的特定 IP 和 Port
HUB_HOST = '192.168.1.100'  # 假設 Hub 的本地 IP
HUB_PORT = 8888

# 雲端服務的端點
CLOUD_ENDPOINT = 'https://your-cloud-service.com/data'
API_KEY = 'a-secure-api-key' # 用於驗證的 API Key

def collect_sensor_data():
    """
    模擬從本地感測器收集資料。
    在真實情境中，這裡可能是從藍牙、Zigbee 或其他本地協議讀取資料。
    """
    return {
        'timestamp': int(time.time()),
        'temperature': 25.5,
        'humidity': 60.2
    }

def send_to_cloud(data):
    """
    將資料安全地傳送到雲端服務。
    """
    headers = {
        'Content-Type': 'application/json',
        'X-API-Key': API_KEY  # 使用 API Key 進行身份驗證
    }
    try:
        # 使用 POST 方法將資料傳送到指定的端點
        response = requests.post(CLOUD_ENDPOINT, data=json.dumps(data), headers=headers, timeout=10)
        
        if response.status_code == 200:
            print(f"Successfully sent data to cloud: {data}")
        else:
            print(f"Failed to send data. Status: {response.status_code}, Body: {response.text}")
            
    except requests.exceptions.RequestException as e:
        print(f"Error connecting to cloud service: {e}")

def main():
    """
    主函數，模擬 Hub 的持續運行。
    注意：這個範例為了簡化，沒有實作一個真正的監聽伺服器。
    它只專注於資料收集和安全地向外傳送。
    Hub 本身不應該開放任何從外部網路可以存取的埠。
    """
    print(f"Smart Home Hub started. Not listening on any public-facing ports.")
    print("Only collecting data and sending to the cloud.")
    
    while True:
        sensor_data = collect_sensor_data()
        send_to_cloud(sensor_data)
        time.sleep(60) # 每分鐘傳送一次

if __name__ == '__main__':
    # 在真實的 Hub 硬體上，這個程式應該作為一個背景服務運行。
    # 它不應該提供任何 shell 或 debug 介面給外部網路。
    main()
```

**Hub 的安全考量：**

*   **無開放埠**：此範例中的 Hub 主動將資料傳出，而不在本地網路上開啟任何可供連入的服務埠，從而消除了來自外部網路的直接攻擊。
*   **單向通訊**：資料流是單向的（Hub -> Cloud），減少了被遠端控制的風險。

---

### 2. 雲端服務 (cloud_service.py)

這個雲端服務使用 Python 的 `Flask` 框架來建立一個 Web 伺服器。它只實作了一個 `/data` 端點，並且只接受 `POST` 請求。

**安裝 Flask:**
```bash
pip install Flask
```

```python
# cloud_service.py
from flask import Flask, request, jsonify

# --- 設定 ---
# 建立 Flask 應用
app = Flask(__name__)

# 預期的 API Key
EXPECTED_API_KEY = 'a-secure-api-key'

# 允許的 IP 地址列表 (可選，增加一層安全性)
# 在生產環境中，這裡應該是 Hub 可能的公網 IP
ALLOWED_IPS = ['203.0.113.1', '198.51.100.2'] 

@app.before_request
def limit_remote_addr():
    """
    在處理每個請求之前，檢查來源 IP 和 API Key。
    """
    # 1. 檢查 API Key
    api_key = request.headers.get('X-API-Key')
    if not api_key or api_key != EXPECTED_API_KEY:
        return jsonify({"error": "Unauthorized"}), 401

    # 2. 檢查來源 IP (可選但建議)
    # request.remote_addr 在有反向代理時可能不準確，需額外設定
    # if request.remote_addr not in ALLOWED_IPS:
    #     return jsonify({"error": "Forbidden"}), 403

@app.route('/data', methods=['POST'])
def receive_data():
    """
    唯一開放的 API 端點，用於接收來自 Hub 的資料。
    """
    # 3. 驗證輸入格式
    if not request.is_json:
        return jsonify({"error": "Invalid content type, expected application/json"}), 400

    data = request.get_json()

    # 4. 驗證資料內容
    required_keys = ['timestamp', 'temperature', 'humidity']
    if not all(key in data for key in required_keys):
        return jsonify({"error": "Missing required fields"}), 400
    
    # 可以在這裡對資料型別或範圍進行更詳細的驗證
    if not isinstance(data['timestamp'], int) or not isinstance(data['temperature'], (int, float)):
        return jsonify({"error": "Invalid data type"}), 400

    # 資料驗證通過，可以進行儲存或處理
    print(f"Received valid data from {request.remote_addr}: {data}")
    
    return jsonify({"status": "success"}), 200

# --- 阻擋所有其他路徑 ---
@app.route('/<path:path>', methods=['GET', 'POST', 'PUT', 'DELETE'])
def block_all_other_routes(path):
    """
    捕獲所有未定義的路徑，並返回 404 Not Found。
    """
    return jsonify({"error": "Not Found"}), 404

@app.route('/', methods=['GET', 'POST', 'PUT', 'DELETE'])
def block_root():
    """
    單獨捕獲根路徑，並返回 404 Not Found。
    """
    return jsonify({"error": "Not Found"}), 404

if __name__ == '__main__':
    # 在生產環境中，應該使用 Gunicorn 或 uWSGI 等 WSGI 伺服器來運行
    # app.run(host='0.0.0.0', port=443, ssl_context='adhoc') # 使用 HTTPS
    # 為了範例簡單，這裡使用 HTTP
    app.run(host='0.0.0.0', port=5000)

```

**雲端服務的安全考量：**

*   **最小 API 端點**：只定義了 `/data` 這一個 `POST` 端點。所有其他路徑（例如 `/`、`/admin`）和方法（`GET`, `PUT`）都會被明確拒絕。
*   **身份驗證**：透過 `X-API-Key` 標頭來確保只有合法的 Hub 才能傳送資料。
*   **IP 白名單**：可以選擇性地啟用 IP 限制，只允許來自已知 IP 的請求。
*   **嚴格的輸入驗證**：在處理資料前，會檢查 `Content-Type`、JSON 格式以及必要的欄位是否存在和其資料型別，防止惡意或格式錯誤的輸入。
