# 5.9 Make systems resilient to outages (使系統對服務中断具有韌性) - 範例系統設計

本文件將依據 `ETSI EN 303 645` 的 `5.9` 條款，設計一個具備服務中斷韌性的智慧家庭中樞系統範例。

## 1. 假設情境

*   **硬體:** Raspberry Pi CM5 (作為智慧家庭中樞)。
*   **軟體:** 基於 Python 的應用程式，負責管理家庭內的 IoT 裝置（如：Zigbee 燈光、藍牙感測器）並與雲端服務同步。
*   **網路:** 透過 Wi-Fi 或乙太網路連接到家庭路由器，並存取網際網路。

## 2. 設計目標

確保在以下常見的中斷情況下，系統仍能維持核心功能、不遺失重要資料，並在服務恢復後自動回復正常運作：

1.  **網際網路連線中斷 (Internet Outage):** 中樞與雲端服務失聯。
2.  **本地網路不穩定 (Local Network Instability):** 中樞與部分本地裝置失聯。
3.  **電源中斷 (Power Outage):** 中樞意外斷電後重啟。

## 3. 系統韌性設計

### 3.1. 網際網路連線中斷應對機制

為了確保在沒有網際網路的情況下，使用者仍能控制家中的基本裝置，系統設計如下：

*   **核心功能本地化:**
    *   所有與本地裝置（例如 Zigbee、Z-Wave、Bluetooth Mesh）的通訊協定與控制邏輯皆在中樞上直接運行。
    *   使用者可以透過本地網路（例如，手機 App 直接連線到中樞的 IP）執行開關燈光、調整空調等基本操作。
    *   自動化規則（例如，日落時開燈、偵測到移動時亮燈）儲存並執行於中樞本地。

*   **狀態快取與佇列 (State Caching & Queuing):**
    *   中樞會在本地資料庫 (例如 SQLite) 中維護一份所有裝置的「最後已知狀態」。
    *   當網路中斷時，所有對裝置狀態的變更（無論來自使用者操作或自動化）會被記錄在一個「待同步佇列」中。
    *   當中樞偵測到網際網路連線恢復時，會自動將佇列中的事件依序傳送到雲端，以確保兩端狀態最終一致。

*   **連線狀態監控:**
    *   系統內建一個 `ConnectionMonitor` 服務，定期 ping 外部伺服器（例如 `8.8.8.8` 或雲端服務的端點），以偵測網路連線狀態。

#### Python 程式碼範例：連線監控與事件佇列

```python
import time
import requests
import sqlite3
import threading

# 假設的事件佇列資料庫
DB_PATH = "/var/data/event_queue.db"

class ConnectionMonitor(threading.Thread):
    def __init__(self):
        super().__init__()
        self.daemon = True
        self.is_connected = False

    def run(self):
        while True:
            try:
                requests.get("https://8.8.8.8", timeout=5)
                if not self.is_connected:
                    print("Internet connection restored.")
                    self.is_connected = True
                    self.sync_events()
            except requests.RequestException:
                if self.is_connected:
                    print("Internet connection lost.")
                    self.is_connected = False
            time.sleep(30) # 每 30 秒檢查一次

    def sync_events(self):
        print("Syncing offline events to the cloud...")
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        # 模擬從佇列讀取並上傳
        for event_id, event_data in cursor.execute("SELECT id, data FROM event_queue"):
            try:
                # response = requests.post("https://cloud.example.com/event", json=event_data)
                # if response.status_code == 200:
                #     cursor.execute("DELETE FROM event_queue WHERE id = ?", (event_id,))
                #     conn.commit()
                print(f"Synced event {event_id}: {event_data}") # 模擬上傳
            except requests.RequestException:
                print("Failed to sync, cloud is not ready. Will retry later.")
                break # 雲端可能尚未完全就緒，稍後重試
        conn.close()
        print("Sync finished.")

# 在主程式啟動時運行
# monitor = ConnectionMonitor()
# monitor.start()
```

### 3.2. 本地網路不穩定應對機制

*   **裝置心跳與重連:**
    *   中樞會為每個本地網路裝置（特別是 Wi-Fi 裝置）維護一個「最後上線時間」。
    *   如果一個裝置在預期時間內沒有回報心跳，系統會將其標記為「離線」，並在 UI 上提示使用者。
    *   系統會定期嘗試與離線裝置重新建立連線。

### 3.3. 電源中斷恢復機制

*   **強固的檔案系統:**
    *   Raspberry Pi CM5 的 eMMC/SD 卡應使用具備日誌功能 (Journaling) 的檔案系統，如 `ext4`，以最大程度地減少因突然斷電造成的檔案系統損壞。

*   **服務自動啟動:**
    *   核心應用程式應被設定為系統服務 (例如使用 `systemd`)。
    *   `systemd` 設定檔會確保在系統開機完成後，應用程式能自動啟動。

*   **啟動時狀態檢查:**
    *   應用程式在啟動時，會執行一個檢查程序：
        1.  讀取本地資料庫，恢復裝置的最後狀態。
        2.  檢查網路連線。
        3.  如果網路正常，則立即與雲端同步一次狀態，確保斷電期間雲端發生的變更（例如使用者透過手機 App 遠端設定）能被拉取到本地。
        4.  檢查待同步佇列，將斷電前未完成的事件上傳。

#### `systemd` 服務設定範例 (`/etc/systemd/system/smarthub.service`)

```ini
[Unit]
Description=Smart Home Hub Service
After=network-online.target

[Service]
ExecStart=/usr/bin/python3 /opt/smarthub/main.py
WorkingDirectory=/opt/smarthub
StandardOutput=inherit
StandardError=inherit
Restart=always
User=pi

[Install]
WantedBy=multi-user.target
```
這個設定檔確保了 `smarthub` 服務會在網路連線後自動啟動，並在意外退出時自動重啟。

## 4. 總結

透過上述設計，這個基於 Raspberry Pi CM5 的智慧家庭中樞能夠：
- 在沒有網際網路時，維持本地控制與自動化。
- 在網路恢復後，自動同步狀態，確保資料不遺失。
- 在電源中斷後，能自動重啟並恢復到斷電前的運作狀態。

這不僅提升了使用者體驗，也符合 `ETSI EN 303 645` 對於系統韌性的核心要求。
