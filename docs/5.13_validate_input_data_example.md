# 5.13 Validate input data (驗證輸入資料) - 範例系統說明

本文件依據 ETSI EN 303 645 的「5.13 驗證輸入資料」規範，並基於先前假設的智慧家庭 IoT 中樞（以 Raspberry Pi CM5 為核心）及其生態系，設計一個範例系統來說明如何實作輸入資料的驗證。

## 1. 系統情境

我們的智慧家庭系統包含以下幾個關鍵部分，每個部分都可能接收到需要驗證的外部輸入：

1.  **智慧家庭中樞 (Smart Home Hub)**：搭載 Raspberry Pi CM5，運行一個基於 Python (FastAPI) 的後端應用程式，處理所有邏輯與裝置溝通。
2.  **使用者介面 (UI)**：
    *   一個網頁應用程式 (Web App)。
    *   一個手機應用程式 (Mobile App)。
3.  **雲端服務 (Cloud Service)**：提供遠端存取、備份與韌體更新服務。
4.  **連線的 IoT 裝置 (Connected Devices)**：如智慧燈泡、溫濕度感測器、智慧門鎖等，透過 Zigbee 或 Wi-Fi 與中樞連線。

輸入資料驗證的目標是確保任何從外部進入系統的資料都是可信、格式正確且在預期範圍內的，以防止惡意攻擊（如 SQL Injection, XSS, 命令注入）或因格式錯誤造成的系統崩潰。

## 2. 輸入驗證的實作策略

資料驗證必須在資料被處理前的「第一時間點」進行，通常是在後端應用程式的 API 接收層。前端驗證可以改善使用者體驗，但絕不能作為安全性的唯一防線。

### 2.1. API 端點的輸入驗證 (中樞後端)

中樞的後端應用程式是所有資料的交會點，因此是實作驗證的核心。我們使用 FastAPI 搭配 Pydantic 模型來進行宣告式的資料驗證，這讓驗證邏輯變得清晰且強大。

**情境：** 使用者透過手機 App 設定一個新的自動化規則，例如「當客廳溫度超過 28°C 時，開啟空調」。

這個請求會被送到中樞的 `/api/rules` 端點。

**Python 程式碼範例 (使用 FastAPI 與 Pydantic):**

```python
# main.py
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel, Field, validator
from typing import Literal

app = FastAPI()

# --- Pydantic 模型：定義資料結構與驗證規則 ---

class Rule(BaseModel):
    rule_name: str = Field(
        ...,
        min_length=3,
        max_length=50,
        description="自動化規則的名稱，長度需介於 3 到 50 之間"
    )
    sensor_id: str = Field(
        ...,
        pattern=r"^sensor-[a-zA-Z0-9]{8}$",
        description="感測器 ID，格式必須為 'sensor-' 開頭加上 8 位英數字元"
    )
    threshold: float = Field(
        ...,
        gt=-20.0,
        lt=100.0,
        description="觸發閾值，溫度必須在 -20°C 到 100°C 之間"
    )
    action: Literal['turn_on_ac', 'send_notification', 'open_window'] = Field(
        ...,
        description="預先定義的合法操作"
    )

    # 自訂驗證邏輯
    @validator('rule_name')
    def validate_rule_name(cls, v):
        # 防止簡單的腳本注入
        if '<' in v or '>' in v:
            raise ValueError('Rule name cannot contain special characters like < or >')
        return v

# --- API 端點 ---

@app.post("/api/rules")
async def create_automation_rule(rule: Rule):
    """
    創建一個新的自動化規則。
    FastAPI 會自動使用 Rule 模型來驗證傳入的 JSON 資料。
    如果驗證失敗，會自動回傳 422 Unprocessable Entity 錯誤。
    """
    try:
        # 在這裡，我們已經可以信任 rule 物件的資料是經過驗證的
        # 可以安全地將其存入資料庫或進行後續處理
        print(f"成功驗證並創建規則: {rule.rule_name}")
        # ... 執行儲存邏輯 ...
        return {"status": "success", "rule_id": "new_rule_123"}
    except Exception as e:
        # 處理其他可能的內部錯誤
        raise HTTPException(status_code=500, detail=str(e))

```

**驗證要點：**

*   **型別驗證 (Type Validation)**：`threshold` 必須是浮點數 (`float`)。
*   **範圍驗證 (Range Validation)**：`threshold` 必須大於 -20 且小於 100。
*   **長度驗證 (Length Validation)**：`rule_name` 的長度必須在 3 到 50 個字元之間。
*   **格式/正規表示式驗證 (Format Validation)**：`sensor_id` 必須符合 `^sensor-[a-zA-Z0-9]{8}$` 的格式。
*   **白名單驗證 (Whitelist Validation)**：`action` 欄位的值必須是 `['turn_on_ac', 'send_notification', 'open_window']` 其中之一。
*   **內容過濾 (Content Filtering)**：透過自訂的 `validate_rule_name` 驗證器，過濾掉可能有害的特殊字元。

### 2.2. 來自 IoT 裝置的資料驗證

從 Zigbee 或 Wi-Fi 裝置傳來的資料同樣不可信。一個被破解的智慧燈泡或感測器可能發送格式錯誤或惡意的資料，企圖癱瘓中樞。

**情境：** 一個 Zigbee 溫濕度感測器每分鐘上報一次資料。

**Python 程式碼範例 (模擬資料接收與驗證):**

```python
# device_gateway.py

def process_sensor_data(raw_data: bytes):
    """
    處理從 Zigbee 閘道傳來的原始感測器資料。
    假設資料格式為 "sensor_id;temperature;humidity"
    例如: b'sensor-a1b2c3d4;25.5;60.2'
    """
    try:
        # 1. 解碼與分割
        decoded_data = raw_data.decode('utf-8')
        parts = decoded_data.split(';')

        if len(parts) != 3:
            print(f"[ERROR] 資料格式錯誤，欄位數量不符: {decoded_data}")
            return

        sensor_id, temp_str, hum_str = parts

        # 2. 驗證各個欄位
        # 驗證 sensor_id 格式
        if not (sensor_id.startswith('sensor-') and len(sensor_id) == 15):
             print(f"[ERROR] Sensor ID 格式不正確: {sensor_id}")
             return

        # 驗證溫度與濕度是否為數字且在合理範圍
        temp = float(temp_str)
        hum = float(hum_str)

        if not (-40.0 < temp < 100.0):
            print(f"[ERROR] 溫度資料超出合理範圍: {temp}")
            return

        if not (0.0 <= hum <= 100.0):
            print(f"[ERROR] 濕度資料超出合理範圍: {hum}")
            return

        # 3. 驗證通過，進行後續處理
        print(f"[INFO] 成功接收並驗證資料: ID={sensor_id}, Temp={temp}, Hum={hum}")
        # ... 更新資料庫或觸發規則 ...

    except (UnicodeDecodeError, ValueError) as e:
        # 處理解碼錯誤或型別轉換失敗
        print(f"[ERROR] 資料解析失敗: {raw_data}, 錯誤: {e}")
    except Exception as e:
        print(f"[ERROR] 未知的處理錯誤: {e}")


# 模擬接收到的資料
process_sensor_data(b'sensor-a1b2c3d4;25.5;60.2') # 合法資料
process_sensor_data(b'sensor-a1b2c3d4;999.9;60.2') # 惡意/錯誤資料 (溫度過高)
process_sensor_data(b'sensor-a1b2c3d4;25.5')      # 格式錯誤資料
process_sensor_data(b'sensor-a1b2c3d4;NaN;60.2')  # 惡意/錯誤資料 (非數字)
process_sensor_data(b'../../etc/passwd;25.5;60.2') # 惡意資料 (路徑遍歷嘗試)
```

## 3. 結論

根據 ETSI EN 303 645 的要求，對所有輸入資料進行嚴格驗證是保護 IoT 系統安全的基礎。

在本範例中，我們展示了一個多層次的驗證策略：

1.  **在 API 核心層**：利用 FastAPI 和 Pydantic 對來自使用者介面或雲端的結構化資料進行強型別、格式、範圍和白名單驗證。
2.  **在裝置接入層**：對來自底層 IoT 裝置的原始資料進行解析和健全性檢查 (Sanity Check)，確保即使裝置本身被入侵，也無法輕易地污染或攻擊核心系統。

這種「零信任 (Zero Trust)」的資料處理原則，即不信任任何外部輸入，是建構一個強韌、安全的智慧家庭系統的關鍵。
