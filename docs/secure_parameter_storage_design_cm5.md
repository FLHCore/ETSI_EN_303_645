# 基於 Raspberry Pi CM5 的敏感參數安全儲存系統設計 (對應 ETSI EN 303 645 5.4)

Raspberry Pi Compute Module 5 (CM5) 作為一個功能強大的應用處理器平台，其本身並不包含像智慧卡那樣內建的防篡改安全晶片。因此，要滿足 `5.4 Securely store sensitive security parameters` 規範，需要採用一種分層、結合軟硬體的策略，利用 CM5 的處理能力和可擴展性來建構一個安全的儲存系統。

### 核心設計理念：依據敏感度分級儲存

不是所有參數都需要同等級別的保護。我們將系統劃分為三個安全等級，並將不同類型的參數儲存在對應的位置。

#### 系統架構

這個架構結合了 CM5 內建的 ARM TrustZone 技術和外接的硬體安全模組。

```
+---------------------------------------------------------------------------------+
|                      設備端 (Raspberry Pi CM5)                                  |
+---------------------------------------------------------------------------------+
| [應用程式層 (Application Layer)] - Linux User Space                             |
|  - Web 服務、MQTT 客戶端、使用者介面等                                          |
|  - 需要金鑰時，透過 TEE Client API 向安全世界請求操作                           |
|  - 不直接接觸私鑰                                                               |
|---------------------------------------------------------------------------------|
| [Linux 核心層 (Kernel Space)]                                                   |
|  - 提供 TEE 驅動程式 (e.g., OP-TEE driver)                                       |
|  - 提供 I2C/SPI 驅動程式與硬體安全模組通訊                                      |
+=================================================================================+
|            ARM TrustZone 硬體隔離邊界 (Hardware Isolation Boundary)             |
+=================================================================================+
| [安全世界 (Secure World / TEE)] - e.g., OP-TEE OS                               |
|  - 運行受信任的作業系統 (Trusted OS)                                            |
|  - 運行受信任應用程式 (Trusted Applications, TAs)                               |
|    - TA 1: 金鑰管理 (Key Management)                                            |
|    - TA 2: 加密操作 (Cryptographic Operations)                                  |
|  - 透過 I2C/SPI 驅動與硬體安全模組通訊                                          |
|  - 儲存「中度敏感」金鑰 (加密後儲存在非安全區)                                  |
+---------------------------------------------------------------------------------+
       ^ |
       | | (透過 I2C/SPI Bus)
       v |
+---------------------------------------------------------------------------------+
| [硬體安全模組 (Hardware Security Module, HSM)] - e.g., ATECC608, TPM 2.0        |
|  - 物理防篡改 (Tamper-resistant)                                                |
|  - 儲存「高度敏感」金鑰 (私鑰永不離開晶片)                                      |
|  - 硬體亂數產生器 (TRNG)                                                        |
|  - 硬體加解密引擎                                                               |
+---------------------------------------------------------------------------------+
```

### 滿足 5.4 條款的具體實現方法

##### **條款 5.4-1: 安全地儲存持久化敏感安全參數**

*   **挑戰**: CM5 的 eMMC/NVMe 快閃記憶體本身是不安全的，可以直接讀取。
*   **實現方式**:
    1.  **高度敏感參數 (Critical Security Parameters)**: 如設備唯一的私鑰、用於安全啟動的根金鑰。
        *   **方案**: 使用外接的**硬體安全模組 (HSM)**，例如 Microchip ATECC608 (透過 I2C) 或 Infineon OPTIGA™ TPM 2.0 (透過 SPI)。
        *   **原理**: 這些晶片被設計為物理防篡改。私鑰在晶片內部產生後，**永遠無法被讀取出來**。所有使用該私鑰的加密操作（如簽章）都在晶片內部完成。Linux 系統只能向晶片發送「請用編號為 2 的金鑰簽署這段資料」的指令，然後接收簽章結果。
    2.  **中度敏感參數**: 如使用者密碼的雜湊值 (Hash) 和鹽值 (Salt)、對稱加密金鑰。
        *   **方案**: 利用 ARM TrustZone 技術，部署一個**可信執行環境 (Trusted Execution Environment, TEE)**，例如開源的 OP-TEE。
        *   **原理**: TEE 創建了一個與主作業系統 (Linux) 硬體隔離的「安全世界」。我們可以在 TEE 中運行一個「受信任應用程式 (TA)」。這個 TA 會產生一個設備唯一的加密金鑰 (DSK)，此金鑰本身受 TEE 保護。當需要在 eMMC 中儲存使用者密碼雜湊時，Linux 會將雜湊值傳給 TA，TA 使用 DSK 對其加密後再返回給 Linux 寫入 eMMC。即使攻擊者直接讀取 eMMC，也只能得到一堆被 DSK 加密的密文。
    3.  **公開安全參數 (Public Security Parameters)**: 如用於驗證伺服器或軟體更新的根 CA 憑證。
        *   **方案**: 將這些公開參數存放在一個唯讀的檔案系統分區 (read-only partition) 中。
        *   **原理**: 這些參數是公開的，不需要保密，但需要保證其**完整性**。結合 `5.7-1 安全啟動`，安全啟動鏈會驗證這個唯讀分區的雜湊值，確保其中的 CA 憑證未被篡改。

##### **條款 5.4-2: 硬編碼的唯一身份需能抵抗篡改**

*   **實現方式**: 這直接對應到使用**硬體安全模組 (HSM)** 的場景。HSM 內部通常會燒錄一個全球唯一的序號，並且其內部儲存的金鑰是與該晶片物理綁定的。任何試圖透過物理或電氣手段來提取金鑰的行為，都會導致晶片永久銷毀金鑰。

##### **條款 5.4-3: 軟體原始碼中不得硬編碼關鍵安全參數**

*   **實現方式**: 這是一個開發流程規範。
    1.  **禁止**: 嚴禁在 Git 儲存庫的任何程式碼或設定檔中出現任何形式的私鑰、API 金鑰或預設密碼。
    2.  **替代方案**:
        *   **動態獲取**: 設備在運行時，透過 API 向 TEE 或 HSM 請求加密操作，而不是直接在程式碼中引用金鑰。
        *   **工廠燒錄**: 在生產線的最後階段，透過安全的燒錄工具，將每個設備唯一的憑證和金鑰注入到 HSM 或 TEE 保護的儲存區中。
        *   **範例程式碼 (錯誤示範)**:
            ```python
            # BAD: Don't do this!
            API_KEY = "my_super_secret_api_key_12345"
            requests.post("https://api.example.com/data", headers={"Authorization": f"Bearer {API_KEY}"})
            ```
        *   **範例程式碼 (正確示範)**:
            ```python
            # GOOD: Requesting a signature from a secure element
            # (This is a conceptual example)
            import secure_element_client
            
            payload = b"data_to_sign"
            signature = secure_element_client.sign(key_slot=3, data=payload)
            # Now use the signature for authentication
            ```

##### **條款 5.4-4: 用於軟體更新和通訊的金鑰需每設備唯一**

*   **實現方式**: 這同樣可以透過 HSM 和工廠燒錄流程來實現。
    1.  **工廠流程**: 在生產線上，為每一片 CM5 配對的 HSM 燒錄一對由工廠 PKI (Public Key Infrastructure) 簽發的設備憑證和對應的私鑰。
    2.  **唯一性**: 因為每個 HSM 都有唯一的私鑰，所以每台設備用於和後端伺服器通訊（例如建立 TLS 連線）時都是獨一無二的。
    3.  **避免自動化攻擊**: 攻擊者即使成功破解了一台設備，也無法用它來冒充或解密任何其他設備的通訊。

### 總結

綜合來看，在 Raspberry Pi CM5 平台上實現 `5.4` 條款的最佳實踐是：

1.  **新增硬體**: 為主機板增加一顆**硬體安全模組 (HSM/SE/TPM)**，用於儲存最高等級的機密。
2.  **啟用軟體隔離**: 利用 CM5 處理器的 **ARM TrustZone** 功能，部署 OP-TEE 等可信執行環境，用於保護中等級別的敏感資料。
3.  **建立安全生產流程**: 設計一套嚴格的**工廠燒錄流程**，將唯一的、非硬編碼的憑證安全地注入到每台設備的 HSM 中。
4.  **遵循開發規範**: 在軟體開發中，徹底杜絕將任何金鑰硬編碼在原始碼中的行為。

這種多層次的防禦策略，將軟體靈活性與硬體安全性相結合，能夠為基於 CM5 的物聯網產品建構一個符合 ETSI EN 303 645 標準的、強大且可靠的安全參數儲存系統。