# ETSI EN 303 645 規範實踐範例

## 5.11 Make it easy for users to delete user data (讓使用者能輕易地刪除使用者資料)

---

### 1. 規範目標

本規範旨在確保消費者能夠輕鬆、透明且完整地刪除其個人資料。這不僅包括帳戶資訊，還涵蓋了所有由使用者活動產生或與其相關的資料。提供清晰的刪除路徑是建立使用者信任和尊重使用者隱私權（如 GDPR 中的「被遺忘權」）的關鍵。

本文件將基於先前假設的「以 Raspberry Pi CM5 為基礎的智慧家庭 IoT 中樞」及其雲端服務，設計一個符合此規範的資料刪除系統。

### 2. 系統架構與資料刪除流程

為了讓使用者能輕易刪除資料，系統必須在使用者介面（App）、雲端後台和 IoT 裝置（中樞主機）之間建立一個連動的刪除機制。

#### 2.1. 涉及的系統元件

1.  **使用者應用程式 (Mobile App / Web Portal)**
    *   **角色**: 使用者操作的進入點。
    *   **設計要求**:
        *   在「帳戶設定」或「隱私權」等易於尋找的區塊提供「刪除資料」或「刪除帳戶」的選項。
        *   提供清晰的說明，告知使用者刪除的後果。
        *   在執行永久性刪除操作前，要求使用者進行身份再驗證（例如，重新輸入密碼）並給予最終警告。

2.  **雲端後台服務**
    *   **角色**: 處理刪除請求的中央協調者。
    *   **設計要求**:
        *   提供安全的 API 端點以接收來自 App 的刪除請求。
        *   執行刪除工作流程，確保資料在所有相關的資料庫、儲存體和快取中被移除。
        *   向 IoT 中樞主機發送指令，要求其刪除儲存在本地的相關資料。

3.  **IoT 中樞主機 (Raspberry Pi CM5)**
    *   **角色**: 儲存本地設定、快取資料和部分日誌的裝置。
    *   **設計要求**:
        *   能安全地接收來自雲端的指令（例如，透過 MQTT 或 HTTPS 長輪詢）。
        *   執行本地資料清除程序，並在完成後向雲端回報。

#### 2.2. 可被刪除的使用者資料分類

在我們的智慧家庭範例中，使用者資料可分為：

*   **帳戶資料**: 姓名、Email、雜湊後的密碼、偏好設定。
*   **裝置資料**: 已配對的裝置清單、裝置名稱、房間分配。
*   **歷史與日誌資料**: 裝置的開關記錄、感測器讀數歷史、場景觸發記錄。
*   **自動化規則**: 使用者自訂的「如果...就...」規則。
*   **遙測資料**: 與使用者身份相關聯的系統效能或診斷資料。

### 3. 刪除機制的實現

系統應提供兩種層級的刪除功能：細粒度刪除與完全刪除。

#### 3.1. 細粒度資料刪除 (Granular Deletion)

允許使用者刪除特定部分資料，而非全部。

*   **範例**: 刪除「客廳溫度計」過去 7 天的歷史紀錄。
*   **流程**:
    1.  使用者在 App 的裝置詳情頁面選擇「清除歷史紀錄」。
    2.  App 呼叫雲端 API：`DELETE /api/devices/{deviceId}/history?period=7d`。
    3.  雲端後台驗證使用者權限後，從時間序列資料庫中刪除對應的紀錄。
    4.  App 顯示「刪除成功」的訊息。

#### 3.2. 帳戶完全刪除 (Full Account Deletion)

提供一個選項讓使用者刪除其帳戶及所有相關聯的資料。

*   **流程**:
    1.  **使用者請求**: 使用者在 App 中選擇「刪除我的帳戶」。系統會要求使用者重新輸入密碼以確認身份，並顯示一個明確的警告，說明此操作不可逆。
    2.  **雲端處理 (第一階段)**:
        *   App 呼叫 `DELETE /api/users/me`。
        *   雲端後台立即將該帳戶標記為「待刪除」，並使其所有登入權杖（Tokens）失效，強制使用者從所有裝置登出。
        *   （可選）系統可以提供一個寬限期（例如 7-14 天），在此期間使用者若重新登入可取消刪除。
    3.  **雲端處理 (第二階段 - 執行刪除)**:
        *   寬限期過後，一個排程的背景工作（Scheduled Job）會啟動。
        *   此工作會從使用者資料庫、裝置資料庫、歷史紀錄資料庫等所有地方，清除與該使用者 ID 相關的所有資料。
    4.  **觸發本地刪除**:
        *   在雲端資料刪除的同時，後台會透過 MQTT 向該使用者註冊的 IoT 中樞主機發布一個刪除指令。主題 (Topic) 範例：`hubs/{hubId}/commands`，訊息 (Payload) 範例：`{"command": "WIPE_USER_DATA", "userId": "user-abc-123"}`。
    5.  **IoT 中樞執行本地刪除**:
        *   中樞主機上的服務接收到指令後，執行本地清除腳本。
        *   刪除儲存在本地 SQLite 資料庫中的設定、清除日誌檔案，並恢復到出廠預設狀態。
        *   完成後，向雲端回報狀態。
    6.  **資料歸檔與備份**: 根據資料保留政策，使用者資料將在下一個備份週期中從備份資料中被永久移除。

### 4. Python 程式碼範例 (IoT 中樞本地刪除邏輯)

以下是一個簡化的 Python 腳本，模擬 IoT 中樞主機如何監聽來自雲端的刪除指令並執行本地資料清除。

```python
# local_data_manager.py
# 執行於 Raspberry Pi CM5 上的服務，使用 paho-mqtt 套件

import paho.mqtt.client as mqtt
import os
import json
import sqlite3
import logging

# 設定日誌
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# --- 組態設定 ---
MQTT_BROKER = "cloud.smarthome-provider.com"
MQTT_PORT = 8883
HUB_ID = "hub-xyz-987" # 裝置的唯一 ID
COMMAND_TOPIC = f"hubs/{HUB_ID}/commands"
STATUS_TOPIC = f"hubs/{HUB_ID}/status"

# 本地資料路徑
USER_CONFIG_PATH = "/data/user_config.json"
LOCAL_DB_PATH = "/data/local_device_logs.db"

def delete_all_user_data():
    """
    執行本地資料的全面清除
    """
    logging.info("Received command to wipe all user data. Starting deletion process...")
    
    # 1. 刪除使用者設定檔
    if os.path.exists(USER_CONFIG_PATH):
        try:
            os.remove(USER_CONFIG_PATH)
            logging.info(f"Successfully deleted user config file: {USER_CONFIG_PATH}")
        except OSError as e:
            logging.error(f"Error deleting file {USER_CONFIG_PATH}: {e}")

    # 2. 清除本地資料庫中的資料
    try:
        conn = sqlite3.connect(LOCAL_DB_PATH)
        cursor = conn.cursor()
        # 假設有一個 `device_logs` 的資料表
        cursor.execute("DELETE FROM device_logs;")
        conn.commit()
        conn.close()
        logging.info(f"Successfully cleared all records from database: {LOCAL_DB_PATH}")
    except sqlite3.Error as e:
        logging.error(f"Error clearing database {LOCAL_DB_PATH}: {e}")

    # 3. 其他清理工作，例如刪除日誌檔案、快取等
    # ...

    logging.info("Local data wipe completed.")
    return True

def on_connect(client, userdata, flags, rc):
    if rc == 0:
        logging.info("Connected to MQTT Broker.")
        client.subscribe(COMMAND_TOPIC)
        logging.info(f"Subscribed to topic: {COMMAND_TOPIC}")
    else:
        logging.error(f"Failed to connect, return code {rc}")

def on_message(client, userdata, msg):
    """
    處理從雲端收到的 MQTT 訊息
    """
    try:
        payload = json.loads(msg.payload.decode())
        command = payload.get("command")
        
        logging.info(f"Received message on topic {msg.topic}: {payload}")

        if command == "WIPE_USER_DATA":
            # 在真實世界中，這裡可能還需要驗證 payload 中的 userId
            success = delete_all_user_data()
            
            # 向雲端回報狀態
            response_payload = {
                "command": "WIPE_USER_DATA",
                "status": "success" if success else "failed"
            }
            client.publish(STATUS_TOPIC, json.dumps(response_payload))
            logging.info(f"Published status to {STATUS_TOPIC}: {response_payload}")

    except (json.JSONDecodeError, UnicodeDecodeError) as e:
        logging.error(f"Failed to decode message payload: {e}")

def main():
    client = mqtt.Client(client_id=f"hub-client-{HUB_ID}")
    # 設定 TLS/SSL
    # client.tls_set(ca_certs="ca.crt", certfile="client.crt", keyfile="client.key")
    client.on_connect = on_connect
    client.on_message = on_message

    try:
        client.connect(MQTT_BROKER, MQTT_PORT, 60)
        client.loop_forever()
    except Exception as e:
        logging.error(f"MQTT client error: {e}")

if __name__ == "__main__":
    main()

```

### 5. 結論

此設計透過在 App、雲端和本地裝置之間建立清晰、連動的流程，為使用者提供了簡單明瞭的資料刪除途徑。它同時支援細粒度刪除和帳戶完全刪除，並在關鍵步驟加入身份驗證和警告，確保了操作的安全性和使用者的知情權。這種多層次、以使用者為中心的設計，完全符合 ETSI EN 303 645 關於資料刪除簡易性的規範要求。
