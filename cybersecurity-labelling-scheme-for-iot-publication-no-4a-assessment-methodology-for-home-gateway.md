gemini chat thread https://gemini.google.com/app/57b56eed88af26fe

## 5.1 – 禁用通用預設密碼 (NO UNIVERSAL DEFAULT PASSWORDS)

### 條款 5.1-1 (Provision 5.1-1)

在任何非出廠預設的狀態下，若有使用密碼，所有消費型物聯網設備的密碼應為每台設備獨一無二 (unique per device)，或由使用者自行定義。

對於家庭閘道器 (Home Gateway, HG)，若 Wi-Fi® 或管理者密碼是在出廠預設中預先配置的，這些預先配置的密碼必須是每台 HG 獨一無二的。

#### 最低要求 (Minimum Requirements)

* 用於認證介面（例如：Telnet、FTP、SSH、設備管理者入口網站、行動應用程式等）的出廠預載/預配置密碼/PIN 碼必須是**每台設備獨一無二**的，亦即同一型號的不同單元擁有不同的出廠預載密碼/PIN 碼。
* 如果出廠預載/預配置密碼/PIN 碼**不是**獨一無二的，設備必須**強制**使用者在初始化時定義新的密碼/PIN 碼。
    * 在更改出廠預載密碼/PIN 碼之前，設備**不得**進入可操作狀態。
* 如果設備沒有預載/預配置密碼/PIN 碼，設備應保持在禁用（非功能性）狀態，直到使用者定義密碼/PIN 碼為止。
* 對於 HG，密碼應符合 **IMDA TS RG-SEC** 定義的密碼要求。要求如下：
    * 密碼長度至少應為 **10**，且必須滿足以下 4 項複雜度規則中的至少 2 項：
        1.  至少 1 個大寫字元 (A-Z)
        2.  至少 1 個小寫字元 (a-z)
        3.  至少 1 個數字 (0-9)
        4.  至少 1 個特殊字元（標點符號和/或空白）
    * 密碼不得有連續相同的字元。
    * 登入 ID 和密碼中使用的值不得相同。
    > (註：這些要求適用於在 IMDA 註冊並打算在新加坡銷售的 HG。否則，HG 應符合 NIST SP 800-63B 數位身分指引中定義的密碼要求。)

#### 佐證證據 (Supporting Evidence)

* 開發商應列出設備所有的認證機制（例如：Telnet、FTP、透過乙太網路埠的 SSH、設備管理者入口網站、行動應用程式、藍牙等）。
* 開發商亦應提供 **NMAP 掃描**結果，以顯示設備上所有開啟的連接埠（適用於 LAN 和 WAN 介面）及相關服務。
    * 連接埠掃描可使用 `nmap -sT -sU -A -p- <ip address>` 執行。
* 開發商應提供證據（例如：使用者手冊、截圖、影片等）以展示或描述設備的設定流程，以及提供給使用者以完成設備初始化的指引（例如：帳號註冊/建立、新增或配對設備等）。

#### 評估 (Assessment)

* 評估人員將檢查 NMAP 掃描結果（適用於 LAN 和 WAN 介面），以判斷開發商提供的認證機制清單是否準確。
* 對於具有非獨一無二預載密碼/PIN 碼的設備，評估人員將檢查設備是否要求使用者在初始化時定義新的密碼/PIN 碼。

---

### 開發者深度導讀 (針對 Gateway / App / Cloud 開發商)

#### 本章節核心要求與意涵

這一條款是許多 IoT 設備最常失敗的地方，特別是針對「新加坡市場」的特殊合規性。

1.  **徹底告別 `admin/admin`**：這是絕對紅線。您有兩條路可選：
    * **路徑 A（硬體成本較高）**：每台機器燒錄不同的隨機密碼，並印在機身貼紙上（Unique per device）。
    * **路徑 B（軟體邏輯較嚴）**：出廠使用通用密碼（或無密碼），但 **首次開機 (OOBE)** 必須強制使用者改密碼，否則機器功能全鎖。
2.  **IMDA 特有的密碼複雜度**：請特別注意，這裡要求 **最少 10 個字元**。這比許多通用的 8 字元要求更嚴格。如果您的 App 前端或 Gateway 後台還在用 `min-length=8` 的檢查邏輯，在新加坡這關會直接 Fail。
3.  **「誠實」的端口管理**：評估方法明確要求使用 `NMAP` 進行全端口掃描 (`-p-` 掃描 1-65535 port)。這意味著開發者不能抱持僥倖心態隱藏 Debug Port (如 Telnet/SSH)。任何被掃出來 Open 的 Port，都必須解釋其認證機制。

#### 具體落地實現方案建議

* **系統設計調整方向**：
    * **強制重置流程 (Forced Reset UI)**：
        * 設計一個「初始化狀態 (Uninitialized State)」。在此狀態下，任何 API call (除了改密碼 API) 都應回傳錯誤（例如 HTTP 403/412），直到密碼被修改。
        * Web GUI 或 App 必須攔截此狀態，並跳出強制修改密碼的視窗，且**不能有「略過」按鈕**。
    * **密碼強度驗證器 (Validator)**：
        * 更新您前端 (App/Web) 與後端 (Gateway Firmware) 的 Regex 規則。
        * 規則範例（需同時滿足）：
            1.  `length >= 10`
            2.  包含 (大寫, 小寫, 數字, 特殊符號) 中的兩項。
            3.  檢查連續字元 (如 `aa`, `11` 不允許)。
            4.  檢查 `Password != UserID`。

* **資料流程與權限設計重點**：
    * **生產線燒錄 (Provisioning)**：如果選擇「每機一密」，需調整產線流程，產生隨機字串 -> 寫入 Flash -> 生成對應 QR Code/貼紙 -> 貼上外殼。資料庫需記錄這組對應關係以備客服查詢（需注意這涉及資安風險，通常不建議雲端明文儲存）。

* **技術與測試配套措施**：
    * **自我掃描**：在提交審查前，QA 團隊**務必**使用與規範相同的指令 `nmap -sT -sU -A -p- <Device_IP>` 掃描您的設備。
        * 確認沒有遺留的工廠測試 Port (如 ADB, Telnet)。
        * 確認開啟的服務 (如 port 80, 443, 8080) 都有對應的密碼保護，且符合上述密碼策略。
    * **證據準備**：
        * 截取「輸入 `123456` 顯示失敗」的畫面。
        * 截取「輸入符合複雜度要求的密碼顯示成功」的畫面。
        * 截取 `NMAP` 的原始 Log 檔。

### 條款 5.1-2 (Provision 5.1-2)

當使用預先安裝的「每台設備獨一無二 (unique per device)」密碼時，這些密碼的產生機制必須能降低針對特定類別或型號設備進行自動化攻擊的風險。

(若設備強制使用者在初始化時定義密碼，則本條款不適用。)

#### 最低要求 (Minimum Requirements)

* 預載密碼**不得**使用遞增計數器（例如："password1"、"password2" 等）。
* 預載密碼必須使用隨機函數進行**充分隨機化**。
* 預載密碼**不得**以明顯的方式與公開資訊（例如：Wi-Fi SSID、MAC 位址、產品序號等）相關聯。
* 預載密碼**不得**包含常見字串或模式（例如："Password123"、"QWERTY" 等）。

#### 佐證證據 (Supporting Evidence)

* 開發商應描述預載密碼是如何產生的（例如：在設備外產生、隨後配置到設備上、或在設備首次啟動程序中產生等）。
* 開發商應宣告用於隨機化預載密碼的密碼產生方法（例如：密碼學安全偽隨機數生成器 CSPRNG 等）。
* 開發商應提供 **10 組**隨機化預載密碼的實例截圖/圖片，這些實例需使用前述宣告的密碼產生方法生成。

#### 評估 (Assessment)

* 評估人員將檢查所使用的密碼產生方法，確認其是否能充分隨機化所生成的預載密碼。
* 此外，評估人員將檢查所提供的 10 組隨機化預載密碼實例，判斷其是否與公開資訊（例如：Wi-Fi SSID、MAC 位址、產品序號等）有明顯的關聯。

---

### 開發者深度導讀 (針對 Gateway / App / Cloud 開發商)

#### 本章節核心要求與意涵

本條款是針對選擇「**路徑 A：每機一密 (Unique Pre-installed Password)**」策略的廠商。如果您選擇了「路徑 B：強制使用者首次登入改密碼」，則本條款通常不適用（但需在文件中註明 N/A 並引用 5.1-1 的實作）。

如果您決定出廠時預設一組密碼（通常印在機身貼紙上），這組密碼的**熵值 (Entropy)** 與**不可預測性**就是審查重點。

1.  **禁止「偽隨機」的衍生算法**：這是最常見的違規設計。例如 `Password = SubString(MD5(MAC Address), 0, 8)`。
    * **為什麼不行？** MAC 位址在無線網路上是公開可見的 (Publicly Available Information)。駭客只要掃描到您的 Wi-Fi MAC，就能反推出 Admin 密碼。條文明確禁止與 MAC/SSID/Serial Number 建立關聯。
2.  **必須使用 CSPRNG**：不能只用普通的 `rand()` 或時間戳記作為種子 (Seed)，必須使用密碼學等級的安全偽隨機數生成器。

#### 具體落地實現方案建議

* **系統設計與產線流程 (Factory Provisioning)**：
    * **密碼生成位置**：建議在產線伺服器 (PC 端) 生成，而非由晶片內部生成（除非晶片具備高品質 TRNG 硬體）。
    * **生成演算法建議**：
        * 使用 Python 的 `secrets` 模組或 OpenSSL 的亂數生成器。
        * **字元集 (Charset)**：排除易混淆字元（如 I, l, 1, O, 0），確保使用者輸入時不會挫折，同時保持足夠長度（建議至少 10 碼以符合 5.1-1 的強度要求）。
    * **資料庫儲存**：產線生成的密碼需與 Serial Number 綁定存入資料庫，以便列印貼紙。**注意**：此資料庫成為高風險資產，需嚴格控管存取權限。

* **證據收集策略**：
    * **生成腳本 (Generation Script)**：開發團隊需準備一份文件，說明產線是如何生成密碼的。例如：「我們使用 HSM (硬體安全模組) 生成亂數」或「使用 Python `secrets.choice()` 腳本」。
    * **樣本清單 (Sample List)**：從產線資料庫中匯出 10 筆真實（或測試用）的 `(Serial Number, Password)` 對照表。
        * **自我檢查**：QA 需檢查這 10 組密碼是否長得太像（例如開頭都是 `Gw`），或是與對應的 MAC/SN 有數學關係。

* **測試與驗證**：
    * **黑箱測試**：收集 100 台機器的密碼，畫出分佈圖，確保沒有明顯規律。
    * **滲透測試觀點**：測試人員會嘗試用 Wi-Fi SSID 或 MAC 位址去「猜」密碼。確保沒有 `Password = SSID + "123"` 這種懶惰設計。

### 條款 5.1-3 (Provision 5.1-3)

用於驗證使用者身分的認證機制，必須使用符合技術屬性、風險與使用情境的最佳實務密碼學技術。

#### 最低要求 (Minimum Requirements)

* 設備的所有機制中，凡是需要傳輸憑證（Credentials）的部分，皆必須透過**安全通道 (secure channel)** 執行。
    * 可接受的範例包括但不限於：
        * **TLS 1.2** 或更高版本，並搭配可接受的加密套件（Cipher Suites，請參考 NIST SP 800-52）。
        * 對於使用藍牙或低功耗藍牙 (BLE) 的設備，需為 **Security Mode 1 with Security Level 3** 或更高（排除 Security Mode 2 with Security Level 1）。
* **不得**使用 HTTP 存取設備的功能（例如：Web GUI、行動應用程式介面等）。
    * 任何透過 HTTP 存取的嘗試都必須被**重新導向 (Redirect)** 至 HTTPS，或者
    * 任何透過 HTTP 存取的嘗試都必須被**拒絕 (Denied)**。
* 所有憑證必須與其他相關服務一起安全地儲存在設備上。
* 儲存在設備上的密碼/權杖 (Tokens) 必須使用符合 **NIST SP 800-131A** 標準的雜湊演算法 (Hash Algorithm) 進行雜湊處理。

#### 佐證證據 (Supporting Evidence)

* 開發商應提供一張**圖表**，包含所有實體（例如：設備、雲端、Hub 等），並說明所使用的安全通訊協定。
    * 範例請參考 **Annex A**。
* 開發商應提供證據（例如：**Wireshark 截圖**等）顯示實體之間的通訊（憑證傳輸過程）。
    * 如適用，IP 位址應標示清楚並位於適當的子網域內。
    * 此類通訊通道的範例包括但不限於：App 到 Hub、Hub 到設備、App 到設備、App 到雲端、設備到雲端。
* 如適用，開發商應提供證據（例如：影片、截圖等），顯示當嘗試透過 HTTP 存取設備管理入口/GUI 時，會發生**重新導向至 HTTPS** 或**拒絕存取**的情況。
* 若憑證儲存在設備上，開發商應描述其如何被安全地儲存。
* 此外，開發商應宣告用於儲存密碼的雜湊演算法，並提供已儲存的雜湊密碼截圖（例如：`/etc/shadow` 檔案截圖）。

#### 評估 (Assessment)

* 評估人員將檢查提供的圖表，確保憑證是透過安全通道傳輸。
* 評估人員將檢查當嘗試透過 HTTP 存取設備管理入口時，是否發生重新導向至 HTTPS 或拒絕存取。
* 此外，若憑證儲存在設備上，評估人員將檢查是否安全儲存。
* 對於儲存在設備上的密碼，評估人員將檢查使用的雜湊演算法是否符合 NIST SP 800-131A。

---

### 開發者深度導讀 (針對 Gateway / App / Cloud 開發商)

#### 本章節核心要求與意涵

本條款重點在於**傳輸中 (In Transit)** 與 **儲存中 (At Rest)** 的憑證保護。

1.  **全線 HTTPS 化 (HTTP is Dead)**：
    * 這不僅是針對「連上網際網路」的介面，連「區網 (LAN)」內的 Web GUI 也必須上 HTTPS。
    * 這對嵌入式開發是一大挑戰，因為需要處理自簽憑證 (Self-signed Certificate) 在瀏覽器跳出警告的問題，或是實作 Let's Encrypt 等自動簽署機制（但在封閉區網難以實現）。儘管如此，合規要求明確：HTTP 必須被關閉或轉址。
2.  **TLS 版本與加密套件 (Cipher Suites) 的嚴格限制**：
    * 不能只開啟 HTTPS 就了事。必須檢查 Web Server (如 uhttpd, nginx, lighttpd) 的 Config，確認 **TLS 1.0 / 1.1** 已被停用。
    * 必須確認 Cipher Suites 排除弱加密（如 RC4, 3DES, MD5）。這需要使用工具（如 `testssl.sh`）來驗證。
3.  **密碼儲存的合規性**：
    * 資料庫或檔案系統中絕對不能出現明文密碼。
    * 不僅要 Hash，還要求演算法符合 NIST SP 800-131A（建議使用 SHA-256 或更高，並加 Salt）。

#### 具體落地實現方案建議

* **系統設計與架構調整**：
    * **強制 HTTPS 重定向**：在 Web Server 設定檔中（例如 Nginx 的 `return 301 https://$host$request_uri;`），確保 Port 80 的流量被轉導至 443，或直接關閉 Port 80。
    * **憑證管理**：
        * 設備出廠時需預載一組自簽憑證（及私鑰）。
        * 注意：為了符合 **Provision 5.1-3**，私鑰的權限必須設為 `600` (root only)，且不可硬編碼在 Firmware image 中（需在產線生成或首次開機生成）。
    * **藍牙安全性**：若是 BLE 設備，開發團隊需檢查 Stack 設定，確認配對模式設為 `Security Mode 1 Level 3` (Authenticated pairing with encryption)，避免使用 "Just Works" 模式（若無 Display/Keyboard 則需提出替代方案或解釋）。

* **證據收集策略 (Evidence Collection)**：
    * **網路架構圖 (Annex A)**：PM 或架構師需繪製一張圖，清楚標示 App、Cloud、Gateway 之間的所有連線，並在連線箭頭旁標註 `HTTPS (TLS 1.2)`。這張圖是必備文件。
    * **Wireshark 抓包 (Annex B)**：
        * QA 必須進行抓包測試。
        * **關鍵截圖**：找到 `Client Hello` 封包，展開 `TLS Record Layer`，清楚顯示 `Version: TLS 1.2` (或 1.3) 以及 `Cipher Suites` 列表。這是證明你沒有使用弱加密的最直接證據。
    * **密碼雜湊證明**：
        * 工程師需 SSH 進設備，執行 `cat /etc/shadow` (或對應的密碼儲存檔)，截圖顯示密碼欄位是亂碼/雜湊值（例如 `$5$` 或 `$6$` 開頭代表 SHA 家族），而非明文。

* **測試與驗證**：
    * **HTTP 阻擋測試**：在瀏覽器輸入 `http://<Device_IP>`，確認是否自動跳轉 `https://` 或顯示「無法連線」。
    * **Cipher Suite 掃描**：使用 `nmap --script ssl-enum-ciphers -p 443 <Device_IP>` 檢查是否支援了不安全的加密演算法。