SECURITY by Design for IOT SDK
===

依據 ETST EN 303 645 IOT cyber security 的規範要求，當一個 IOT 網關產品要提供 APP SDK （手機應用程式 APP 開發的 sw develop toolkit) 以及 IOT 網關網路服務 Cloud Service SDK 的方案，要如何設計一個符合 303 645 規範，同時確保提供客戶的 APP SDK & Cloud Service SDK 的開發彈性，以下是三個不同 easy, normal , hard 難度等級的方案，重點在於** (作為製造商) 必須強制執行關鍵的安全邊界**，同時為客戶 (開發者) 提供彈性。

---

### 💡 核心設計原則 (基於 ETSI 303 645)

無論採用何種方案，您的 SDK 都必須圍繞以下幾個核心 ETSI 條款來設計，以確保合規性：

1.  **身份驗證 (5.1 & 5.4):** SDK 絕不能允許使用通用預設密碼。SDK 必須強制使用唯一的憑證，並且絕不能允許將 API 金鑰或密碼等關鍵安全參數硬編碼在 APP 原始碼中。APP SDK 應使用作業系統提供的安全儲存機制（如 Keychain, Keystore）來儲存 Token。
2.  **安全通訊 (5.5):** 所有 SDK 產生的網路通訊（無論是 App 到 Cloud，還是 App 到 Gateway）都必須使用最佳實踐加密技術（例如 TLS 1.2+）。SDK 不應提供關閉加密的選項。
3.  **最小攻擊面 (5.6):** 您的 SDK 應遵循最小權限原則。例如，APP SDK 不應允許開發者任意啟用網關上的偵錯介面 或開啟不必要的網路服務。
4.  **資料保護 (5.8 & 6):** 處理個人資料時，傳輸必須加密。Cloud SDK（後端）必須提供機制讓 APP SDK 能夠實作使用者同意 與撤回同意。
5.  **資料刪除 (5.11):** 您的 Cloud Service SDK 必須提供 API 端點，讓 APP SDK 可以觸發刪除該使用者在設備 和相關服務 上的個人資料。

---

### 方案一：Easy (簡易級 - 託管方案)

此方案優先考慮**合規性**和**易用性**，犧牲了開發彈性。您提供了近乎完整的應用程式和後端服務，SDK 僅用於微幅調整。

* **方案描述：** 「白牌 (White-label)」方案。
* **APP SDK (UI 擴充套件):**
    * 您提供一個功能完整的 APP 核心。
    * SDK 只允許開發者更改 UI 元素，如 Logo、配色方案、字體。
    * 所有核心功能，如設備配對、使用者登入、韌體更新、資料刪除 的流程是**鎖定且不可修改的**。
    * 開發者無法更改通訊協定、加密方式 或金鑰管理。
* **Cloud Service SDK (Webhook 介面):**
    * 您提供完整的雲端後台。
    * 「SDK」實際上只是一組 Webhook API。開發者無法在您的雲上執行自訂代碼。
    * 開發者只能訂閱「事件」（例如：設備上線、觸發警報），您的雲會將這些事件推播到開發者自己的伺服器。
    * 所有符合 ETSI 規範的邏輯（如資料刪除、漏洞管理）都由您的雲端平台處理。
* **合規性與彈性：**
    * **合規性：** **高**。您完全控制了所有安全相關的實施。
    * **彈性：** **低**。開發者幾乎沒有自訂功能的空間。

---

### 方案二：Normal (標準級 - 沙盒方案)

此方案提供了**彈性**與**安全**的最佳平衡點。您提供了一個安全的「平台」，開發者可以在您設定的「沙盒」範圍內進行開發。這是最推薦的方案。

* **方案描述：** 「平台即服務 (PaaS)」方案。
* **APP SDK (模組化 SDK):**
    * 您提供多個**強制性**的安全模組：
        1.  **認證模組：** 處理所有登入、Token 刷新、並強制使用安全儲存。
        2.  **通訊模組：** 封裝所有 API 請求，強制使用 TLS 和 payload 加密。
        3.  **隱私模組：** 提供標準化的 UI 介面，用於獲取使用者同意 和觸發資料刪除。
    * 開發者可以自由編寫 APP 的其餘部分（業務邏輯、UI），但只要涉及與雲端或網關的通訊，就**必須**呼叫這些安全模組。
* **Cloud Service SDK (Serverless 方案):**
    * 您提供一個「Serverless Functions」環境（類似 AWS Lambda 或 Google Cloud Functions）。
    * 開發者可以上傳自訂的後端代碼（例如 Python, Node.js）到您的雲平台。
    * 您的平台會**自動處理**：
        1.  **API 閘道：** 強制所有傳入的請求都經過身份驗證。
        2.  **輸入驗證：** 對抗常見攻擊（如 SQL 注入）。
        3.  **資料庫抽象：** 開發者使用您提供的資料庫 API，該 API 自動將資料與使用者 ID 綁定，並內建了資料刪除 和個資保護 邏輯。
    * 開發者可以專注於業務邏輯，而無需管理底層的安全基礎設施。
* **合規性與彈性：**
    * **合規性：** **高**。您定義了安全的邊界和強制性的模組，開發者很難繞過。
    * **彈性：** **中**。開發者可以在沙盒內自由地實現所需功能。

---

### 方案三：Hard (進階級 - 構建塊方案)

此方案提供了**最大彈性**，但將大部分**安全實施責任**轉移給了開發者。此方案風險最高，需要額外的合規措施。

* **方案描述：** 「基礎設施即服務 (IaaS) / 函式庫」方案。
* **APP SDK (底層函式庫):**
    * 您只提供底層的函式庫（Libraries），例如：
        1.  一個用於網關通訊的「BLE 協定庫」。
        2.  一個用於後端通訊的「HTTP 客戶端庫」（可能預設開啟了 TLS）。
        3.  一個「加密工具庫」。
    * 開發者**必須自己**：
        * 實作完整的登入和 Token 管理流程。
        * 決定如何安全地儲存金鑰。
        * 呼叫正確的 API 來刪除資料。
        * 設計並實作所有隱私同意流程。
* **Cloud Service SDK (後端函式庫):**
    * 您允許開發者在**他們自己選擇的任何雲平台**（如 AWS, Azure）上建立和託管他們自己的後端。
    * 您的 SDK 只是作為函式庫（例如 Java .jar / Node .npm）提供，幫助他們：
        * 解析來自網關的資料包。
        * 驗證設備身份。
    * 開發者**必須自己**：
        * 建立和維護他們的資料庫。
        * 實作所有 API 端點（包括資料刪除 API）。
        * 負責所有後端安全、輸入驗證 和資料靜態加密。
* **合規性與彈性：**
    * **合規性：** **低 (風險高)**。您的產品是否符合 ETSI 303 645，將完全取決於您的客戶 (開發者) 的實施品質。
    * **彈性：** **極高**。開發者擁有完全的控制權。
* **合規的必要條件：**
    如果您選擇此方案，為了聲明您的「整體產品」符合 ETSI 規範，您**必須**透過合約和流程來強制執行合規性。例如：
    * **強制認證：** 要求開發者必須將他們完成的 APP 和後端服務提交給您進行**強制性的安全稽核**，通過後才能發布。
    * **嚴格的開發者指南：** 提供一份詳細文件，明確說明開發者如何使用您的 SDK 來滿足 303 645 的每一項要求（例如：「您必須這樣實作 5.11-2 資料刪除...」）。

---

### 總結建議

對於大多數尋求平衡的 IoT 製造商而言，**方案二 (Normal - 沙盒方案)** 通常是最佳選擇。

它使您能夠控制核心的安全架構（符合 ETSI 303 645），同時為您的客戶提供足夠的彈性來打造差異化的應用程式和服務。

(design by Gemini 2.5 pro)