## 5.5 – 安全通訊 (COMMUNICATE SECURELY)

### 條款 7.5-6 (Provision 7.5-6)

若使用防火牆，防火牆配置的預設設定必須提供最嚴格的配置，以保護非專業 (layman) 使用者。

#### 最低要求 (Minimum Requirements)

* 若家庭閘道器 (HG) 提供的任何服務在運作期間被**停用 (deactivated)**，則對應的**連接埠 (ports) 必須關閉**。
* 在 HG 初始化時，防火牆功能必須被**啟用**。最嚴格的防火牆配置必須：
    * **允許**來自私有網路 (Private Network) 的所有**外發通訊 (outgoing communication)**。
    * **拒絕**來自公共網路 (Public Network) 的所有**未經請求的傳入通訊 (unrequested incoming communication)**。

#### 佐證證據 (Supporting Evidence)

* 開發商應提供初始 **NMAP 掃描**結果，顯示設備上所有開啟的連接埠及相關服務。
* 開發商隨後應**停用**任何一項服務，並再次執行 **NMAP 掃描**，以證明該停用服務的對應連接埠已關閉。
    * 可使用以下指令：`nmap -sT -sU -A -p- <ip address>`。
* 開發商應提供證據（例如：截圖、影片等），證明來自私有網路的所有外發通訊是被允許的，而來自公共網路的所有未經請求傳入通訊是被拒絕的。
    * 範例包括：
        * GUI 中的防火牆配置規則。
        * 命令列介面 (CLI) 指令（例如：`iptables -L OUTPUT -n -v` 顯示外發規則，`iptables -L INPUT -n -v` 顯示傳入規則）。

#### 評估 (Assessment)

* 評估人員將檢查並確保 Wi-Fi 路由器上所有已停用的服務，其對應的連接埠皆已關閉。
* 評估人員將檢查 Wi-Fi 路由器設定，確認來自私有網路的所有外發通訊是被允許的，且來自公共網路的所有未經請求傳入通訊是被拒絕的。

---

### 開發者深度導讀 (針對 Gateway / App / Cloud 開發商)

#### 本章節核心要求與意涵

本條款定義了路由器的**「預設防禦姿態 (Default Security Posture)」**。

1.  **狀態防火牆 (Stateful Firewall) 的強制性**：
    * 條款要求「拒絕未經請求的傳入通訊」。這意味著防火牆必須具備**狀態感知能力 (Stateful Inspection)**。
    * 簡單的 ACL (Access Control List) 是不夠的，必須能區分「主動連線的回傳封包 (ESTABLISHED/RELATED)」與「外部主動發起的連線 (NEW)」。
2.  **服務與連接埠的連動**：
    * 這是常見的 Bug：使用者在 UI 上關閉了 "FTP Server"，但背後的 `vsftpd` Process 沒殺乾淨，或者防火牆規則沒更新，導致 Port 21 還是 Open（雖然可能連不上，但 Port 是開的）。
    * 合規要求：**Service OFF = Port CLOSED**。

#### 具體落地實現方案建議

* **系統設計與 iptables/nftables 設定**：
    * **預設策略 (Default Policy)**：
        * WAN Interface 的 INPUT Chain 預設必須是 `DROP`。
        * LAN Interface 的 FORWARD Chain (to WAN) 預設通常是 `ACCEPT`。
    * **關鍵規則實作**：
        * 允許已建立的連線：`iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT`。
        * 丟棄無效封包：`iptables -A INPUT -m state --state INVALID -j DROP`。
        * 針對特定服務（如 SSH, Web GUI）的開孔，必須依賴 UI 的開關動態插入/移除規則。

* **證據收集策略**：
    * **iptables 截圖**：
        * 這是最硬核的證據。SSH 進設備，執行 `iptables -L -v -n` 或 `nft list ruleset`。
        * 標註出 `Chain INPUT (policy DROP)` 以及 `state ESTABLISHED,RELATED` 這幾行。
    * **NMAP 對照組**：
        * **Before**：開啟 SSH 服務 -> Nmap 掃描顯示 Port 22 Open。
        * **After**：關閉 SSH 服務 -> Nmap 掃描顯示 Port 22 Closed (或 Filtered)。
        * 這兩張圖並排，能完美證明「服務與連接埠連動」。

* **測試與驗證**：
    * **外部攻擊模擬**：
        * QA 將設備 WAN Port 接到測試儀器（模擬 Public Internet）。
        * 使用 Nmap 對 WAN IP 進行全端口掃描。
        * **預期結果**：除了必要的 ICMP (Ping) 或特定的管理 Port（若有開），其他所有 Port 都應該是 `Filtered` 或 `Closed`。
    * **反向連線測試**：
        * 在 LAN 端 PC 發起對外連線（如瀏覽 Google），確認能通（驗證 Outgoing Allowed）。
        * 嘗試從 WAN 端主動 Ping 或 Telnet LAN 端的 PC IP（驗證 Unrequested Incoming Denied）。