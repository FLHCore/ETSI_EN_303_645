## 5.3 – 保持軟體更新 (KEEP SOFTWARE UPDATED)

### 條款 5.3-10 (Provision 5.3-10)

當更新是透過網路介面傳遞時，設備必須透過信任關係 (trust relationship) 驗證每次更新的真實性 (authenticity) 與完整性 (integrity)。

#### 最低要求 (Minimum Requirements)

* 設備必須透過**信任關係**驗證每次更新的真實性與完整性（所有認可的密碼學演算法請參考 NIST SP 800-131A）。建立信任關係的範例包括但不限於：
    * 使用認可的密碼學演算法（例如：RSA-4096-SHA512 等）進行**數位簽章**的韌體更新。
    * 設備與更新伺服器之間使用認可的密碼學演算法進行**金鑰對認證 (Key-pair authentication)**。
    * 使用 **SSL Pinning**。
* 特別是針對**手動更新**，必須使用認可的密碼學演算法（例如：RSA-4096-SHA512 等）的數位簽章來建立信任關係。
* (對於從家庭閘道器 (HG) 推送更新到設備的情況，HG 必須負責驗證韌體更新的真實性與完整性。)

#### 佐證證據 (Supporting Evidence)

* 開發商應宣告設備所建立的信任關係類型，以用於驗證更新的真實性與完整性。
* 開發商應宣告驗證過程中所使用的**密碼學演算法**（包括更新是從 Hub 推送到設備的情況）。

#### 評估 (Assessment)

* 評估人員將檢查設備是否建立了驗證更新真實性與完整性的信任關係。
* 評估人員將檢查開發商宣告的密碼學演算法是否未被棄用，且符合 NIST SP 800-131A。

---

### 開發者深度導讀 (針對 Gateway / App / Cloud 開發商)

#### 本章節核心要求與意涵

本條款與 **Provision 5.3-9** 非常相似，但多了一個關鍵場景：**「子設備 (Sub-devices) 的更新代理」**。

1.  **Gateway 作為 Hub 的責任**：
    * 如果您的 Gateway 同時也是 Zigbee, Z-Wave, 或 Bluetooth Mesh 的 Hub，負責管理其他低功耗感測器（如門窗感測器、燈泡）。
    * 這些小設備通常運算能力有限 (Constrained Devices)，可能無法跑 RSA-4096 驗證。
    * **條款要求**：在這種情況下，**Gateway (HG) 必須擔任把關者**。Gateway 從雲端下載子設備的韌體後，必須先在 Gateway 端完成簽章驗證，確認無誤後，再透過區域無線協議推送到子設備。
2.  **網路傳遞的信任鏈**：強調「透過網路介面」傳遞的更新，不能只依賴傳輸層安全 (TLS)，必須有應用層的信任驗證（如簽章或 Pinning）。

#### 具體落地實現方案建議

* **系統設計與架構調整**：
    * **Hub 代理驗證機制**：
        * 設計流程：`Cloud -> (下載) -> Gateway -> [Gateway 驗證簽章] -> (驗證通過) -> Gateway 透過 Zigbee OTA Cluster 推送 -> Sensor`。
        * 絕對不能做成：`Cloud -> Gateway (只做轉發) -> Sensor`。如果 Gateway 不驗證直接轉發，若雲端被駭或傳輸被劫持，所有子設備都會被植入惡意軟體。
    * **演算法的一致性**：
        * 即便是驗證子設備的韌體，Gateway 端使用的驗證演算法仍需符合 **NIST SP 800-131A** (如 SHA-256 以上)。

* **證據收集策略**：
    * **架構圖補充**：在系統架構圖中，針對 "Sub-device Update" 的路徑，標註 "Signature Verification performed by Gateway"。
    * **演算法宣告清單**：
        * "Main Firmware: RSA-4096 / SHA-512"
        * "Zigbee Bulb Firmware: ECDSA P-256 / SHA-256 (Verified by Gateway)"
    * **代理驗證的 Log**：截取 Gateway 的 System Log，顯示它下載了子設備韌體，並執行了驗證程序（例如：`[Updater] Verifying accessory_firmware.bin... Signature OK`）。

* **測試與驗證**：
    * **子設備惡意更新測試**：
        * QA 在雲端後台（或模擬伺服器）上傳一個簽章錯誤的子設備韌體。
        * 觸發 Gateway 更新子設備。
        * **預期結果**：Gateway 下載後，在 Log 中顯示「驗證失敗」，並**拒絕**發起對子設備的 OTA 傳輸。這是證明 Gateway 有盡到把關責任的關鍵。

---
[回到 5.3 – 保持軟體更新 (KEEP SOFTWARE UPDATED)](./5.3-keep-software-updated.md)
