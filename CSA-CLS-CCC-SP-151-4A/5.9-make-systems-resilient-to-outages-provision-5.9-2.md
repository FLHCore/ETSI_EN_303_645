## 5.9 - 使系統對中斷具有韌性 (MAKE SYSTEMS RESILIENT TO OUTAGES)

### 條款 5.9-2 (Provision 5.9-2)

家庭閘道器 (HG) 在失去網路存取的情況下，必須保持運作且具備本地功能 (locally functional)；在電力中斷後恢復時，必須在無需使用者操作的情況下，自動恢復到先前的連線與配置狀態。

#### 最低要求 (Minimum Requirements)

* HG 必須具備在外部網路存取中斷的情況下，仍能在區域網路 (local network) 內保持運作與功能的應變能力。
* HG 必須具備在電力恢復後，自動返回到先前的連線與配置狀態，且無需使用者採取任何行動的能力。

#### 佐證證據 (Supporting Evidence)

* 開發商應宣告 HG 是否具備在失去網路存取時保持運作與功能的能力。
* 開發商應宣告 HG 是否具備在電力恢復後，自動恢復到先前的連線與配置狀態，且無需使用者採取任何行動的能力。

#### 評估 (Assessment)

* 評估人員將檢查 HG 是否具備在失去網路存取的情況下保持運作與功能的能力，以及在電力恢復後，是否能在無需使用者操作的情況下自動恢復到先前的連線與配置狀態。

---

### 開發者深度導讀 (針對 Gateway / App / Cloud 開發商)

#### 本章節核心要求與意涵

本條款關注的是系統的**可用性 (Availability)** 與 **韌性 (Resilience)**，特別針對「斷網」與「斷電」兩種常見情境。

1.  **本地優先 (Local-First) 架構**：
    * **情境**：網路斷線了，使用者的手機還連著 Wi-Fi。這時候，使用者應該還能透過 App 控制家裡的智慧燈泡開關，或者存取 NAS 裡的檔案。
    * **合規紅線**：如果您的 Gateway 架構是「雲端依賴型 (Cloud-Dependent)」，即所有的指令（即使是區域網路內的控制）都要先送到雲端再送回來，一旦斷網，設備就變成磚頭。這是不符合「保持本地功能」要求的。
2.  **狀態記憶 (State Persistence)**：
    * **情境**：跳電後復電。
    * **要求**：路由器不應該重置為出廠預設值，也不能停在「等待設定」的畫面。它必須「記得」它跳電前是誰（SSID）、密碼是什麼、防火牆開了什麼洞，並且自動連回 ISP。
    * **零接觸恢復 (Zero-Touch Recovery)**：使用者不需要去按開機鍵，也不用登入 App 點擊「重新連線」。

#### 具體落地實現方案建議

* **系統設計與架構調整**：
    * **混合控制路徑 (Hybrid Control Path)**：
        * App 端設計應具備「本地發現 (mDNS/SSDP)」能力。
        * 邏輯：`if (Cloud_Unreachable) { Try_Local_API(Gateway_IP); }`。
        * Gateway 端必須在 WAN 斷線時，確保 DHCP、DNS (Local Resolve)、HTTP Server 仍正常運作。
    * **非揮發性儲存 (NVRAM/Flash) 策略**：
        * **設定即存檔 (Commit on Change)**：任何使用者設定的變更（如修改 Wi-Fi 密碼），必須立即寫入 Flash (如 `nvram commit` 或 `uci commit`)，不能只留在 RAM 中。
        * **開機腳本 (Init Script)**：確保開機流程會讀取最後一次的 Config，並自動帶起 `pppd` (撥號) 或 `dhcp-client`。

* **證據收集策略**：
    * **斷網測試影片**：
        * 拔掉 WAN 線。
        * 展示手機仍連著 Wi-Fi。
        * 展示 App 仍能成功登入 Gateway 管理頁面，或控制連接在 Gateway 下的子設備。
    * **斷電恢復測試影片**：
        * 拍攝目前設定（例如 LED 燈是亮的，Wi-Fi SSID 是 "TestHome"）。
        * 直接拔掉電源插頭，等待 10 秒，插回電源。
        * 拍攝自動開機過程，證明數分鐘後，Wi-Fi "TestHome" 自動出現，且設備恢復運作，中間無人為操作。

* **測試與驗證**：
    * **邊緣案例測試**：
        * 測試「正在更新韌體時斷電」的恢復機制（這通常涉及 Dual Image / A+B Partition 的設計，雖非此條款明文要求，但屬韌性的一環）。
        * 測試「PPPoE 撥號失敗」的自動重試機制（Backoff Retry），確保不會因為 ISP 短暫斷線就永久放棄連線。