## 5.4 – 安全地儲存敏感安全參數 (SECURELY STORE SENSITIVE SECURITY PARAMETERS)

### 條款 5.4-4 (Provision 5.4-4)

在設備軟體中，任何用於軟體更新完整性與真實性檢查，以及用於保護與相關服務通訊的關鍵安全參數，都必須是**每台設備獨一無二 (unique per device)** 的，且必須透過能降低針對整類設備進行自動化攻擊風險的機制產生。

#### 最低要求 (Minimum Requirements)

* 用於軟體/韌體更新完整性與真實性檢查的關鍵安全參數（例如：密鑰、憑證的私鑰部分等）必須是**每台設備獨一無二**的。
    * (開發商的公鑰**不要求**每台設備獨一無二。)

#### 佐證證據 (Supporting Evidence)

* 開發商應提供證據，顯示所使用的關鍵安全參數是每台設備獨一無二的。
* 開發商應描述設備所使用的關鍵安全參數之產生過程。
* 開發商應提供證據，顯示關鍵安全參數是透過能降低針對整類設備進行自動化攻擊風險的機制產生的。

#### 評估 (Assessment)

* 評估人員將檢查關鍵安全參數的產生過程，確保它們是每台設備獨一無二的，且具備能降低針對整類設備進行自動化攻擊風險的機制。

---

### 開發者深度導讀 (針對 Gateway / App / Cloud 開發商)

#### 本章節核心要求與意涵

本條款的核心在於防止**「類別破解 (Class Break)」**。

1.  **什麼是類別破解？**
    * 如果所有出廠的設備都共用同一把私鑰（Shared Private Key）來連線雲端或解密參數。一旦駭客從其中一台設備中提取出這把鑰匙，全球所有同型號的設備都會同時淪陷。
    * **每機一密 (Unique Key Per Device)**：要求每台設備擁有自己獨立的私鑰（通常是 Client Certificate Private Key）。這樣即使一台設備被攻破，損害也僅限於該台設備，不會波及整個艦隊 (Fleet)。
2.  **更新驗證的特殊性**：
    * 條款中特別提到 **更新 (Updates)**。這通常指：
        * **傳輸層驗證 (mTLS)**：設備連線到 Update Server 時，使用自己的 Unique Key 證明身分。
        * **韌體解密 (Decryption)**：如果韌體是加密傳輸的，解密金鑰應該是 Unique 的（雖然實務上常使用 Session Key 或由 Unique Key 衍生的金鑰）。
    * **注意例外**：條款明確說「開發商的公鑰 (Developer's Public Key)」**不需要** Unique。這是合理的，因為韌體通常是統一簽章發布的 (Broadcasting)，設備端只需用同一把公鑰驗證簽章即可。

#### 具體落地實現方案建議

* **系統設計與產線流程 (Provisioning)**：
    * **On-board Key Generation (最佳實務)**：
        * 在產線測試階段，指令設備內部的安全晶片 (SE) 或 MCU 自行生成 RSA/ECC Key Pair。
        * 設備匯出公鑰 (CSR, Certificate Signing Request) 給產線伺服器。
        * 產線伺服器（扮演 CA 角色）簽署憑證後回傳給設備。
        * **優點**：私鑰從未離開過設備，安全性最高。
    * **Factory Injection (次佳方案)**：
        * 產線伺服器生成 Key Pair，透過安全通道寫入設備 Flash。
        * **風險**：需確保產線伺服器不留存私鑰備份，且寫入過程未被監聽。

* **證據收集策略**：
    * **憑證抽樣檢查**：
        * 從 3 台不同設備中導出 Client Certificate (公鑰部分)。
        * 比較其 Serial Number 或 Public Key Hash。
        * **預期結果**：3 台設備的數值完全不同。
    * **產線 Log 截圖**：
        * 提供產線自動化程式的 Log，顯示 "Generating Key Pair for Device SN: 123..." 以及 "Sign CSR..." 的過程。

* **測試與驗證**：
    * **互斥性測試**：
        * 嘗試將 Device A 的憑證與私鑰複製到 Device B。
        * 如果後端有做嚴格檢查（例如綁定 MAC Address 或 SN），Device B 使用 A 的憑證連線時應被拒絕（視後端實作而定，雖非本條款強制，但屬最佳實務）。

---
[回到 5.4 Securely Store Sensitive Security Parameters](./5.4-securely-store-security-parameters.md)