## 5.3 – 保持軟體更新 (KEEP SOFTWARE UPDATED)

### 條款 5.3-7 (Provision 5.3-7)

設備必須使用最佳實務的密碼學技術來促進安全的更新機制。

#### 最低要求 (Minimum Requirements)

* 在設備與更新伺服器（即雲端）之間傳輸的數據，必須使用**認可的密碼學演算法**（參考 NIST SP 800-131A）進行加密。
* 或者，設備與更新伺服器之間的更新傳輸通道必須受到保護，使用 **TLS 1.2** 或更高版本，並搭配可接受的**加密套件 (cipher suites)**（參考 NIST SP 800-52）。

#### 建議 (Recommendation)

* 對於任何適用韌體校驗和 (checksums) 的應用，開發商應採用 **SHA-2** 以及 NIST SP 800-52 中提及的其他任何認可的密碼學演算法。

#### 佐證證據 (Supporting Evidence)

* 開發商應提供證據（例如：**Wireshark 截圖**、**tcpdump** 等），顯示設備與更新伺服器之間傳輸的數據是經過加密的，並清楚標示來源 IP 與目的 IP 位址。
* 對於不支援或不需要軟體/韌體更新的**受限設備 (constrained devices)**，本條款可能不適用。
    * 對於此類情況，開發商應提供理由，說明為何該設備不需要支援和/或軟體/韌體更新。
* 開發商亦應提供截圖（例如：**testssl.sh** 腳本、**cipherscan** 等），顯示傳輸通道使用的是符合 NIST SP 800-52 的可接受加密套件。
* 關於 TLS 的實作，請參考 **Annex B** 以獲得更多資訊。

#### 評估 (Assessment)

* 評估人員將檢查提供的證據，以判斷傳輸的數據是否使用認可的密碼學演算法進行加密。
* 評估人員將檢查提供的證據，確保設備與更新伺服器之間的傳輸通道是使用 **TLS 1.2** 或更高版本，並搭配可接受的加密套件（參考 NIST SP 800-52）。
* 對於不需要支援和/或更新的受限設備，評估人員將檢查開發商提供的理由是否充分解釋了為何該設備不需要支援和/或更新。

---

### 開發者深度導讀 (針對 Gateway / App / Cloud 開發商)

#### 本章節核心要求與意涵

本條款專注於更新過程中的**傳輸機密性 (Confidentiality)**。

1.  **不僅僅是下載**：雖然韌體本身可能有簽章（完整性保護），但若透過 HTTP 明文下載，攻擊者可以分析流量、攔截請求，甚至進行中間人攻擊 (MitM) 竄改下載連結。因此，**強制 HTTPS** 是此條款的核心。
2.  **伺服器端的責任**：這條款的合規壓力不只在設備端 (Client)，更在**雲端更新伺服器 (Server)**。如果您的 AWS S3 Bucket 或 OTA Server 支援老舊的 TLS 1.0/1.1 或弱加密套件 (Weak Ciphers)，即便設備端支援 TLS 1.2，評估仍可能失敗。
3.  **受限設備的例外**：如果您的產品是極低功耗的感測器（如電池供電的 Zigbee 門窗感測器），本身無法連網更新（需透過 Hub），則可以申請「受限設備」的例外，但必須詳細說明其更新限制（或透過 Hub 更新的機制）。

#### 具體落地實現方案建議

* **系統設計與 Server 設定**：
    * **更新伺服器強化 (Server Hardening)**：
        * 請 DevOps 團隊檢查 OTA 下載伺服器（例如 Nginx, Apache, 或 CDN 設定）。
        * 設定 `ssl_protocols TLSv1.2 TLSv1.3;`。
        * 設定 `ssl_ciphers` 以排除 RC4, 3DES, CBC 模式等弱演算法。
    * **設備端實作**：
        * 使用 `libcurl` 或 `wget` 下載韌體時，務必指定 HTTPS URL。
        * 啟用 **Certificate Pinning**（憑證鎖定）是最佳實務，能有效防止偽造憑證的 MitM 攻擊，雖然此條款僅要求 TLS 1.2，但 Pinning 能展現更高的安全性。

* **證據收集策略**：
    * **Wireshark 抓包 (Client 端證據)**：
        * 在設備執行 OTA 更新時進行側錄。
        * 截圖重點：證明連線是走到 Port 443 (HTTPS)，且內容是亂碼（Application Data），而非明文的韌體檔頭。
    * **伺服器掃描 (Server 端證據)**：
        * 使用 `testssl.sh <update_server_domain>` 指令。
        * **必備截圖**：截取報告中的 "Protocols" 部分（顯示 TLS 1.2/1.3 為綠色，SSLv2/v3/TLS1.0/1.1 為紅色或未支援）以及 "Cipher Suites" 部分。這直接證明了伺服器的合規性。

* **測試與驗證**：
    * **HTTP 回退測試 (Downgrade Attack)**：QA 嘗試將下載連結改為 `http://`，驗證設備是否會拒絕連線或自動轉導至 `https://`。
    * **憑證驗證測試**：QA 使用自簽憑證或無效憑證架設一個偽造的 OTA Server，驗證設備是否會因為憑證錯誤而中止更新（防止 MitM）。

---
[回到 5.3 – 保持軟體更新 (KEEP SOFTWARE UPDATED)](./5.3-keep-software-updated.md)
