## 5.13 - 驗證輸入數據 (VALIDATE INPUT DATA)

### 條款 5.13-1 (Provision 5.13-1)

消費型物聯網設備軟體必須驗證透過使用者介面輸入、或透過應用程式介面 (API) 傳輸、或在服務與設備的網路之間傳輸的數據。

#### 最低要求 (Minimum Requirements)

* 必須針對設備的所有介面（包含配套應用程式與其他相關服務）驗證輸入數據，以減少數據處理期間發生非預期行為。

#### 建議 (Recommendations)

* 關於輸入數據驗證的具體細節與最佳實務，請參考 **OWASP 的 Input Validation Cheat Sheet**。
* 此外，為了降低數據過度暴露的風險並防止對核心功能的存取，設備介面應限制為僅包含設備運作所需的部分。

#### 佐證證據 (Supporting Evidence)

* 開發商應提供設備所有接收輸入數據並進行處理的介面清單（例如：設備管理者入口網站、配套應用程式的登入頁面等）。
* 開發商亦應提供證據（例如：截圖、影片等），顯示設備具備輸入數據驗證功能，能**拒絕無效 (invalid) 與格式錯誤 (malformed) 的請求**。
* 或者，開發商應描述在上述宣告的所有設備介面上實作的輸入驗證機制。

#### 評估 (Assessment)

* 評估人員將檢查開發商提供的介面清單是否完整（即：驗證設備、其配套應用程式與相關設備內的所有登入介面是否皆已列入考量）。
* 評估人員將檢查證據，以判斷設備是否能夠拒絕無效與格式錯誤的請求。
    * 這必須至少針對那些經過驗證、允許更改認證值和/或資訊的設備介面進行驗證。

---

### 開發者深度導讀 (針對 Gateway / App / Cloud 開發商)

#### 本章節核心要求與意涵

本條款是防禦 **注入攻擊 (Injection Attacks)** 與 **緩衝區溢位 (Buffer Overflow)** 的基礎。

1.  **零信任輸入 (Zero Trust Input)**：
    * 任何來自外部的資料（無論是使用者在 UI 打的字、App 發送的 JSON、還是 Cloud 下發的指令）都必須被視為「有毒的」，直到經過驗證為止。
    * **常見漏洞**：
        * **Command Injection**：在 Wi-Fi SSID 欄位輸入 `; rm -rf /;`。如果後端直接用 `system("iwconfig " + ssid)` 執行，設備就會變磚。
        * **SQL Injection**：在登入欄位輸入 `' OR '1'='1`。
        * **XSS**：在設備名稱輸入 `<script>alert(1)</script>`。
2.  **範圍涵蓋全端**：
    * 條款特別提到 **"Transferred via APIs"**。這意味著您不能只在前端 App 做檢查（因為攻擊者可以繞過 App 直接打 API），**後端 (Gateway/Cloud) 必須有自己的驗證邏輯**。

#### 具體落地實現方案建議

* **系統設計與驗證邏輯**：
    * **白名單驗證 (Allow-list Validation)**：
        * 不要只嘗試過濾「壞字元」（黑名單很難列全）。
        * 應定義「什麼是合法的」。例如：SSID 僅允許 `[a-zA-Z0-9_ -]`，長度 1-32。
    * **使用成熟的 Schema Validator**：
        * 對於 JSON API，使用 **JSON Schema** 進行驗證。
        * 對於 Web Form，使用後端框架內建的 Validator (如 Laravel Validation, Spring Boot Validation)。
    * **參數化查詢 (Parameterized Queries)**：
        * 針對資料庫操作，絕對禁止字串串接 SQL。

* **證據收集策略**：
    * **錯誤處理截圖**：
        * **場景 1 (長度限制)**：在密碼欄位輸入 1000 個 'A'，截取 "Input too long" 的錯誤訊息。
        * **場景 2 (非法字元)**：在 IP Address 欄位輸入 "999.999.999.999" 或 "abc"，截取 "Invalid IP format" 的錯誤訊息。
    * **API 回應截圖**：
        * 使用 Postman 發送一個缺少必要欄位 (Missing Field) 或型別錯誤 (Type Mismatch) 的 JSON。
        * 截取 Server 回傳 **HTTP 400 Bad Request** 的畫面。

* **測試與驗證**：
    * **Fuzz Testing (模糊測試)**：
        * 使用工具 (如 Burp Suite Intruder, OWASP ZAP) 對所有輸入欄位發送大量隨機亂碼、特殊符號、超長字串。
        * **預期結果**：系統應回傳錯誤訊息，但**絕對不能 Crash (崩潰)** 或回傳 **500 Internal Server Error** (這通常代表沒接好的 Exception，可能導致資訊洩漏)。