## 5.3 – 保持軟體更新 (KEEP SOFTWARE UPDATED)

### 條款 5.3-9 (Provision 5.3-9)

* **a.** 家庭閘道器 (HG) 必須驗證軟體更新的真實性 (authenticity) 與完整性 (integrity)。
* **b.** HG 僅在認證與驗證成功的情況下，方可安裝更新。

#### 最低要求 (Minimum Requirements)

* 設備必須透過**信任關係 (trust relationship)** 驗證每次更新的真實性與完整性（所有認可的密碼學演算法請參考 NIST SP 800-131A）。建立信任關係的範例包括但不限於：
    * 使用認可的密碼學演算法（例如：RSA-4096-SHA512 等）進行**數位簽章**的韌體更新。
    * 設備與更新伺服器之間使用認可的密碼學演算法進行**金鑰對認證 (Key-pair authentication)**。
    * 使用 **SSL Pinning**。
* 特別是針對**手動更新**，必須使用認可的密碼學演算法（例如：RSA-4096-SHA512 等）的數位簽章來建立信任關係。

#### 佐證證據 (Supporting Evidence)

* 開發商應宣告路由器所建立的信任關係類型，以用於驗證更新的真實性與完整性。
* 開發商應宣告驗證過程中所使用的**密碼學演算法**。

#### 評估 (Assessment)

* 評估人員將檢查路由器是否建立了驗證更新真實性與完整性的信任關係。
* 評估人員將檢查開發商宣告的密碼學演算法是否未被棄用，且符合 NIST SP 800-131A。

---

### 開發者深度導讀 (針對 Gateway / App / Cloud 開發商)

#### 本章節核心要求與意涵

本條款與 **5.3-2** (更新機制) 及 **7.3-7** (簽章要求) 高度相關，但側重點在於**設備端的驗證執行 (Verification Execution)**，特別是針對「手動更新」場景的強制要求。

1.  **信任關係的多樣性與限制**：
    * 對於線上更新 (OTA)，您可以選擇透過 SSL Pinning (鎖定伺服器憑證) 或 數位簽章 (簽署檔案) 來建立信任。
    * **關鍵差異**：對於**手動更新**（使用者上傳檔案），因為沒有連線過程，**只能依賴數位簽章**。單純的 Checksum (MD5/SHA256) 只能驗證完整性，無法驗證真實性（來源），因此不符合要求。
2.  **演算法合規性**：再次強調 NIST SP 800-131A 的重要性。如果您還在使用 RSA-1024 或 SHA-1，這在驗證階段會被視為無效。

#### 具體落地實現方案建議

* **系統設計與邏輯調整**：
    * **手動更新的強制驗證邏輯**：
        * 許多開發者會在 Web GUI 的上傳功能中偷懶，只檢查檔案檔頭 (Header) 或大小。
        * **必須實作**：`Upload -> Save to /tmp -> Verify Signature (使用 Public Key) -> If Valid then Install else Delete`。
    * **SSL Pinning (針對 OTA)**：
        * 若選擇此方案，App 或 Device 端的 HTTP Client 需內建 Server 端的憑證 Hash。
        * **維運風險提示**：憑證過期或輪替時，若設備端未更新 Pinning Hash，會導致無法連線。建議優先採用「數位簽章」方案，因為公鑰通常比 SSL 憑證壽命更長且更易管理。

* **證據收集策略**：
    * **信任關係宣告書**：這是文件審查的重點。
        * 範例文字："For OTA updates, we utilize **SSL Pinning** to ensure the connection is to our trusted server. For manual updates, we enforce **RSA-4096 Digital Signature Verification** on the firmware image."
    * **錯誤處理展示**：
        * 雖然此條款主要要求「宣告」，但準備一張「上傳簽章錯誤的檔案導致更新失敗」的截圖，能強力佐證您的宣告並非空談。

* **測試與驗證**：
    * **中間人攻擊模擬 (針對 OTA)**：QA 使用 Proxy (如 Charles 或 Burp Suite) 攔截流量，嘗試餵給設備一個偽造的韌體包。若有做 SSL Pinning 或簽章驗證，設備應拒收。
    * **偽造簽章測試 (針對手動更新)**：
        * 拿一個正確的韌體，用錯誤的私鑰簽署。
        * 拿一個正確的韌體，保留正確簽章，但修改內容。
        * 以上兩種情況，設備都必須拒絕更新。

---
[回到 5.3 – 保持軟體更新 (KEEP SOFTWARE UPDATED)](./5.3-keep-software-updated.md)
